<link rel="import" href="dependencies.html" />
<dom-module id="guuey-notify">
  <template>
    <firebase-document
      id="notifyTargetDB"
      app-name="main"
      data={{notifyTargetData}}>
    </firebase-document>

    <firebase-document
      id="notifiableDB"
      app-name="main">
    </firebase-document>

    <firebase-document
      id="deNotifiableDB"
      app-name="main">
    </firebase-document>

    <firebase-document
      id="timesDB"
      app-name="main"
      data="{{timesData}}">
    </firebase-document>

  </template>
</dom-module>
<script>
  Polymer({
    is:"guuey-notify",
    properties:{
      notifyRoute:{
        type:String,
        observer:"ready"
      },
      conditionType:{
        type:String
      },
      notifyMessage:{
        type:String
      },
      notifyUrl:{
        type:String
      },
      //used for setting the id of the info that is being notified on
      notifyTarget:{
        type:String
      },
      //used for daily med notifcations only
      timesRoute:{
        type:String
      },
      originalTarget:{
        type:String
      },
      newTarget:{
        type:String,
        observer:"compareTargets"
      },
      notifyData:{
        type:Object
      },
      immediate:{
        type:Boolean,
        value:false
      },
      readyToCompare:{
        type:Boolean,
        value:false
      }
    },
    initialize:function(){
      this.$.notifyTargetDB.path=this.notifyRoute;
      this.$.timesDB.path=this.timesRoute;
      this.$.notifyTargetDB.getStoredValue(this.notifyRoute)
        .then(function(snapshot){
          this.originalTarget=snapshot;
          if(this.immediate){
            this.routeNotification();
          } else {
            this.readyToCompare=true;
          };
        }.bind(this));
    },
    observers:[
      "notifyTargetChanged(notifyTargetData)"
    ],
    notifyTargetChanged:function(data){
      if(this.$.notifyTargetDB.ref){
        this.$.notifyTargetDB.ref.once("value",function(snapshot){
          this.newTarget=snapshot.val();
        }.bind(this));
      }
    },
    _computeTime:function(timeData, timeChunk){
      var newestCandidate;
      var currentChunk=timeData[timeChunk];
      for(x in currentChunk){
        var candidate=currentChunk[x];
        if(newestCandidate!=null){
          if(newestCandidate.log.time<candidate.log.time){
            newestCandidate=candidate;
          }
        } else {
          newestCandidate=candidate;
        };
      };
      if(newestCandidate){
        return newestCandidate.time;
      } else {
        return;
      }
    },
    setDailyMedNotify:function(){
      var path="homes/"+this.home+"/notifications/notifiable/"+this.notifyTarget;
        this.originalTarget.med.timeChunk.forEach(function(chunk){
          var time=this._computeTime(this.timesData, chunk);
          this.notifyData={
            message:this.notifyMessage,
            url:this.notifyUrl,
            location:this.$.notifyTargetDB.path,
            conditions:{
              type:this.conditionType,
              weekdays:this.originalTarget.med.weekdays,
              repeatTime:time
            },
            history:{
              notifiable:Date.now()
            },
          };
          this.$.notifiableDB.setStoredValue(path+"-"+chunk, this.notifyData)
          this.$.notifiableDB.path=null;
          this.notifyData=null;

        }.bind(this));
    },
    setDefaultNotify:function(){
      var path="homes/"+this.home+"/notifications/notifiable/"+this.notifyTarget;
      this.notifyData={
        message:this.notifyMessage,
        url:this.notifyUrl,
        location:this.$.notifyTargetDB.path,
        conditions:{
          type:this.conditionType,
          condition:Date.parse(this.newTarget)
        },
        history:{
          notifiable:Date.now()
        },
      };
      this.$.notifiableDB.setStoredValue(path, this.notifyData)
      this.$.notifiableDB.path=null;
      this.notifyData=null;
    },
    compareTargets:function(){
      if(this.readyToCompare){
        if(this.newTarget!=this.originalTarget){
          this.routeNotification();
        };
      };
    },
    routeNotification:function(){
      if(this.conditionType==="dailyMeds"){
        this.setDailyMedNotify();
      } else {
        this.setDefaultNotify();
      };
    },
    //use when deleting an object that potentially has notifications on it
    //operates off of the original path and home
    deNotify:function(home, notifyTarId, suffixes){
      var notifiableRoute="homes/"+home+"/notifications/notifiable/"+notifyTarId;
      var notifyRoute="homes/"+home+"/notifications/notify/"+notifyTarId;
      if(suffixes){
        for(i=0; i<suffixes.length; i++){
          var notifiableRoute="homes/"+home+"/notifications/notifiable/"+notifyTarId+"-"+suffixes[i];
          var notifyRoute="homes/"+home+"/notifications/notify/"+notifyTarId+"-"+suffixes[i];
          this.$.deNotifiableDB.setStoredValue(notifiableRoute, null);
          this.$.deNotifiableDB.setStoredValue(notifyRoute, null);
        }
      } else {
        this.$.deNotifiableDB.setStoredValue(notifiableRoute, null);
        this.$.deNotifiableDB.setStoredValue(notifyRoute, null);
      };
    }
  });
</script>
