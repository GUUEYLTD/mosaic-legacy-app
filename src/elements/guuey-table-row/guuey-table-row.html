<!--
used to write a row to of checkbox options in the guuey-table
arguments:
rowdata(string)
  the name of the row and where to save the data to
tableroute(string)
  the location in the database that the row should sync to
home(string)
  used to determine database paths REQUIRED
patient
  used to determine database paths REQUIRED
-->
<link rel="import" href="dependencies.html" />
<dom-module id="guuey-table-row">

  <template>
    <firebase-document
      id="mainTableDB"
      app-name="main"
      data="{{mainTableDataLive}}"
      path="[[tableroute]]">
    </firebase-document>

    <app-indexeddb-mirror
      key="mainTableDB|[[tableroute]]"
      data="{{mainTableDataLive}}"
      persisted-data="{{mainTableData}}"
      worker-url="../../../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror-worker.js">
    </app-indexeddb-mirror>

    <firebase-document
      id="tableDB"
      app-name="main"
      data="{{tableData}}">
    </firebase-document>

    <iron-media-query
      query="(max-width:1660px)"
      query-matches="{{query1660}}">
    </iron-media-query>

    <style>
      custom-row{
        display:table-row;

      }
      custom-cell{
        display:table-cell;
        width:var(--thead-tr-td-width);
      }
      custom-cell{
        min-width:var(--td-th-min-width);

      }
      custom-cell:last-of-type{
        width:var(--td-th-last-width);
      }
      .comment{
        max-width:200px;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
      }
    </style>
    <!--dialogue that works to add comments to a table row-->
    <paper-dialog id="tableComment">
      <h2>Add/update Comment</h2>
      <paper-input label="comment" value="{{tableData.comment}}"></paper-input>
    </paper-dialog>

    <custom-row>
      <custom-cell>[[rowdata]]</custom-cell>

      <custom-cell>
        <paper-dropdown-menu label="Frequency">
          <paper-listbox attr-for-selected="label" selected="{{frequency}}" class="dropdown-content">
            <paper-item label="daily">Daily</paper-item>
            <paper-item label="weekly">Weekly</paper-item>
            <paper-item label="biWeekly">Bi-Weekly</paper-item>
            <paper-item label="monthly">Monthly</paper-item>
            <paper-item label="yearly">Yearly</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>
      </custom-cell>

      <custom-cell class="comment">
        <paper-icon-button
          id="[[rowdata]]"
          on-tap="toggleDialog"
          icon="communication:comment">
        </paper-icon-button>
        [[mainTableData.comment]]
      </custom-cell>
    </custom-row>
  </template>

  <script>

    Polymer({
      is:'guuey-table-row',
      properties:{
        page:{
          type:String
        },
        home:{
          type:String
        },
        patient:{
          type:String
        },
        rowdata:{
          type:String
        },
        tableroute:{
          type:String
        },
        mainTableData:{
          type:Object,
        },
        frequency:{
          type:String,
          observer:"dropdownChanged"
        }
      },
      observers:[
        "editQuery(query1660)",
        "checkRowData(mainTableData)",
        "populateRow(mainTableData)"
      ],
      populateRow:function(data){
        for(x in data){
          if(data[x]===true){
            this.frequency=x;
          };
        };
      },
      dropdownChanged:function(frequency){
        var frequencyArray=[
          "daily",
          "weekly",
          "biWeekly",
          "monthly",
          "yearly"
        ];
        //horrible workaround due to bad previous method of saving data with checkboxes... i'm sorry future dev...
        if(frequency!=null){
          var path=this.tableroute;
          this.$.tableDB.path=null;
          this.$.tableDB.data=null;
          this.$.tableDB.data=true;
          this.$.tableDB.save(path,frequency)
            .then(function(){
              for(i=0; i<frequencyArray.length; i++){
                if(frequencyArray[i]!=frequency){
                  this.$.tableDB.path=null;
                  this.$.tableDB.data=null;
                  this.$.tableDB.data=false;
                  this.$.tableDB.save(path,frequencyArray[i]);
                };
              };
            }.bind(this));

        };
      },
      checkboxChanged:function(e){
        this.$.tableDB.path=null;
        this.$.tableDB.data=null;

        if(e.target.checked===true){
          this.$.tableDB.data=true;
          var path=this.tableroute;
          this.$.tableDB.save(path,e.target.value)
            .then(function(){
              //something to do when complete
            });
        } else {
          this.$.tableDB.data=null;
          var path=this.tableroute;
          this.$.tableDB.save(path,e.target.value)
            .then(function(){
              //something to do when complete
            });
        }
      },
      toggleDialog:function(e){
        this.$.tableDB.path=null;
        this.$.tableDB.data=null;
        this.$.tableDB.path=this.tableroute;
        this.$.tableComment.toggle();

      },
      checkRowData:function(data){
        if(!data.daily && !data.weekly && !data.biWeekly && !data.monthly){
          this.fire("rowDataMissing", {rowInfo:this.rowdata, tableName:this.tablename});
        } else {
          this.fire("rowDataExists", {rowInfo:this.rowData, tableName:this.tablename});
        };
      },
      editQuery:function(query1660){
        if(query1660){

        } else {

        };
      }
    });

  </script>
</dom-module>
