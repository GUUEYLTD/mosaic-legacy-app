<!--takes as arguments:
used to dynamically display tables that update and reflect to the database location specified
tableroute(string)
  where to save the table entries in the database
tableinputs(array)
  an array of inputs for the table needs to be declared in the parent element
category(string)
  the category of the inputs that are being declared
label(string)
  label to put in the heading area above the table
label2(string)
  second label to put in the heading area above the table
patient(string)
  required in order for the element to know where to save/get checkbox entries
home(string)
  required in order for the element to know where to save/get checkbox entries
-->

<link rel="import" href="dependencies.html" />

<dom-module id="guuey-table">

  <template>
    <firebase-document
      id="mainTableDB"
      app-name="main"
      data="{{mainTableData}}"
      path="{{tableroute}}">
    </firebase-document>

    <iron-media-query
      query="(max-width:1300px)"
      query-matches="{{query1300}}">
    </iron-media-query>
    <style>
      .sectionHeading{
        background-color:#42c6ff;
        width:100%;
      }
      .sectionHeadingText{
        font-size: 24px;
        color:#FFFFFF;
      }
      .subHeadingText{
        color:#FFFFFF;
      }
      .container{
        padding:16px;
      }
      .tableScrollLabel{
        font-weight:bold;
        text-transform:uppercase;
        margin-bottom:0px;
        padding-bottom:0px;
        font-size:10px;
        padding-left:20px;
        color:var(--table-scroll-lable-color);
      }
      .tableContainer{
        height:auto;
        overflow:var(--table-overflow);
      }
      paper-card{
        width:90%;
        margin:20px 5% 20px 5%;
      }
      table{
        background-color:var(--table-background-color);
        width:100%;
      }
      tbody{
        display:var(--tbody-display);
      }
      thead tr{
        width:100%;
        position:var(--thead-tr-position);
        display:var(--thead-tr-display);
      }
      td{
        width:var(--thead-tr-td-width);
      }
      td,th{
        width:33%;
        width:var(--thead-tr-td-width);
        min-width:var(--td-th-min-width);
        text-align:left;
      }
      td,th:last-of-type{
        max-width:200px;
        width:var(--td-th-last-width);
      }
    </style>

    <paper-card>
      <div class="sectionHeading">
        <div class="container">
          <p class="sectionHeadingText">
            [[label]]
          </p>
          <p class="subHeadingText">
            [[label2]]
          </p>
        </div>
      </div>
      <div class="container tableContainer">
        <p class="tableScrollLabel">
          swipe left scrolls table
        </p>
        <table>
          <thead>
            <tr>
              <th>[[category]]</th>
              <th>Frequency</th>
              <th>Commments</th>
            </tr>
          </thead>
          <tbody>
              <template is="dom-repeat" items="{{tableinputs}}" as="rowdata">
                <!--see element for details-->
                  <guuey-table-row
                    rowdata="[[rowdata]]"
                    tableroute="[[tableroute]]/[[rowdata]]"
                    home="[[home]]"
                    patient="[[patient]]"
                    tablename="[[label]]">
                  </guuey-table-row>
                  <br />
              </template>
          </tbody>
        </table>
      </div>
    </paper-card>
  </template>

  <script>

    Polymer({
      is:'guuey-table',
      ready:function(){
        this.addEventListener("rowDataMissing", this.addToastText);
        this.addEventListener("rowDataExists", this.removeToastText);
      },
      properties:{
        page:{
          type:String
        },
        patient:{
          type:String
        },
        label:{
          type:String
        },
        label2:{
          type:String
        },
        tableinputs:{
          type:Array
        },
        tableroute:{
          type:String
        },
        mainTableData:{
          type:Object,
          reflectToAttribute:true
        },
        category:{
          type:String
        },
        missingRows:{
          type:Object,
          value:{}
        }
      },
      observers:[
        "editQuery(query1300)"
      ],
      checkboxChanged:function(e){
        this.$.tableDB.path=null;
        this.$.tableDB.data=null;

        if(e.target.checked===true){
          this.$.tableDB.data=true;
          var path=this.tableroute+"/"+e.target.id;
          this.$.tableDB.save(path,e.target.value)
            .then(function(){
              //something to do when complete
            });
        } else {
          this.$.tableDB.data=null;
          var path=this.tableroute+"/"+e.target.id;
          this.$.tableDB.save(path,e.target.value)
            .then(function(){
              //something to do when complete
            });
        }
      },
      toggleDialog:function(e){
        var section=e.model.item;
        this.$.tableDB.path=null;
        this.$.tableDB.data=null;
        this.$.tableDB.path=this.tableroute+"/"+section
        this.$.tableComment.toggle();

      },
      tableDataLoc:function(value, section){
        var path=this.tableroute+"/"+section+"/"+value;
        this.$.mainTableDB.getStoredValue(path)
          .then(function(returnValue){
            return returnValue;
          });
      },
      editQuery:function(query1300){
        if(query1300){
          this.customStyle["--table-scroll-lable-color"]="inherit";
          this.customStyle["--table-overflow"]="scroll";
          this.customStyle["--tbody-display"]="block";
          this.customStyle["--thead-tr-position"]="relative";
          this.customStyle["--thead-tr-display"]="block";
          this.customStyle["--thead-tr-td-width"]="150px";
          this.customStyle["--td-th-min-width"]="150px";
          this.customStyle["--td-th-last-width"]="150px";
          this.updateStyles();
        } else {
          this.customStyle["--table-scroll-lable-color"]="transparent";
          this.customStyle["--table-overflow"]="unset";
          this.customStyle["--tbody-display"]="block";
          this.customStyle["--thead-tr-position"]="relative";
          this.customStyle["--thead-tr-display"]="block";
          this.customStyle["--thead-tr-td-width"]="150px";
          this.customStyle["--td-th-min-width"]="150px";
          this.customStyle["--td-th-last-width"]="150px";
          this.updateStyles();
        }
      },
      addToastText:function(e){
        if(e.detail.tableName===this.label){
          this.missingRows=this.label;
          this.missingRows[e.detail.rowInfo]=true;
          var toastText=this.label+" is missing: ";
          for(x in this.missingRows){
            if(x!="name"){
              if(this.missingRows[x]!=false){
                toastText+=" "+x+" ";
              };
            };
          };
          this.fire("openToast", {toastText:toastText});
        };
      },
      removeToastText:function(e){
        if(e.detail.tableName===this.label){
          if(this.missingRows[e.detail.rowInfo]){
            this.missingRows[e.detail.rowInfo]=false;
          };
          var toastText=this.label+" is missing: ";
          var origLength=toastText.length;
          for(x in this.missingRows){
            if(x!="name"){
              if(this.missingRows[x]!=false){
                toastText+=" "+x+" ";
              };
            };
          };
          if(toastText.length>origLength){
            this.fire("openToast", {toastText:toastText});
          };
        };
      }
    });

  </script>
</dom-module>
