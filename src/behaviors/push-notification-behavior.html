<link rel="import" href="../../bower_components/polymer/polymer.html" />

<script>

  (function(){
    "use-strict";
    /*
    @polymerBehavior Polymer.pushNotificationBehavior
    */
    Polymer.pushNotificationBehavior = {

      is:"push-notification-behavior",

      properties: {
        messagingToken: {
          type: String
        },

        messagingActive: {
          type: Boolean,
          value: false
        },

        deviceNames: {
          type: Object,
          value:{}
        },

        newDevice: {
          type: String,
          observer: "_newDeviceChanged"
        },

        currentDevice: {
          type: String,
          computed: "_computeCurrentDevice(user.uid, deviceNames, newDevice)",
        }
      },

      ready:function() {

      },

      _computeCurrentDevice: function(uid, deviceNames, newDevice) {
        if(newDevice) {
          return newDevice;
        } else {
          return deviceNames && deviceNames[this.user.uid] ? deviceNames[this.user.uid] : null;
        };
      },

      _newDeviceChanged: function(device) {
        if(device) {
          this.set("deviceNames." + this.user.uid, device);
        };
      },

      requestNotificationPermission: function() {
        var that = this;
        this.$.messaging.requestPermission()
          .then(function(token) {
            that.$.messagingTokenDB.setStoredValue(that.$.messagingTokenDB.path, that.$.messaging.token);
            that.fire("openToast", {toastText: "Push notifications have been setup! You will now receive push notifications."})
            var path = "/homes/" + that.home + "/users/" + that.user.uid + "/settings/notificationSources/" + that.currentDevice;
            that.$.userSettingsDB.setStoredValue(path, {deviceLoggedIn: true, active: true});
            that.$.requestNotificationModal.close();
            that.fire('resetDialogOverlay');
          })
          .catch(function(err) {
            console.log(err);
            that.fire("openToast", {toastText: "You must accept in order to get push notifications."});
            that.$.requestNotificationModal.close();
            that.fire('resetDialogOverlay');
          });
      },

      setDeviceLoggedIn: function(active) {
        var path = "/homes/" + this.home + "/users/" + this.user.uid + "/settings/notificationSources/" + this.currentDevice + "/deviceLoggedIn";
        return this.$.userSettingsDB.setStoredValue(path, active);
      },

      _handleMessage: function(e) {
        console.log(e);
      }

    };

  })();

</script>
