<link rel="import" href="../../bower_components/polymer/polymer.html" />

<script>

  (function(){
    "use-strict";
    /*
    @polymerBehavior Polymer.pageChangeMiddleware
    */
    Polymer.pageChangeMiddleware={
      is:"page-change-middleware",

      observers:[
        "_middleware(page)",
        "_userTypeReady(home, user)",
        "_authKnown(statusKnown, signedIn)",
      ],

      properties:{

        allowedPages: {
          type: Array,
          value: [
            "ad-support"
          ]
        },

        //routes that do not get overriden by not being logged in
        noAuthRoutes: {
          type: Array,
          value: [
            "/default/default/def-verify",
            ]
        },

      },

      ready: function() {
        this.addEventListener('dbLoading', this.enableDBLoading);
        this.addEventListener('dbLoaded', this.disableDBLoading);
        this.addEventListener('pageLoaded', this.pageFirstLoad);
      },

      //take in route as string and check against no auth routes
      authRequired:function(route){
        var noAuthRoutes=this.noAuthRoutes;
        if(noAuthRoutes.indexOf(route)===-1){
          return false;
        } else {
          return true;
        };
      },

      _authKnown:function(known, signedIn){
        if(known) {
          if(!signedIn && !this.authRequired(this.$.location.path)){
            this.$.loginDialog.open();
          } else {
            if(this.user){
              this.$.userIndexDB.getStoredValue("/userIndex/"+this.user.uid+"/home")
                .then(function(value){
                  this.set('homeData.home', value);
                  this.$.loginDialog.close();
                }.bind(this))
            };
          };
        };
      },

      pageAllowed: function(page) {
        return this.allowedPages.indexOf(page) !== -1;
      },

      _userTypeReady: function(home, user) {
        if(user && user.uid) {
          this.$.userTypeDB.path = "/homes/" + home + "/users/" + user.uid + "/role";
          this.$.userTypeDB.ref.on("value", function(snap) {
            this.currentUserType = snap.val();
            this.checkAdmin();
          }.bind(this));
        };
      },

      checkAdmin: function() {
        if(this.catData.category === "admin" && !this.pageAllowed(this.page)) {
          if(this.currentUserType === "admin" || this.currentUserType === "manager") {
            return;
          } else {
            var userType = this.currentUserType;
            var cat = this.catData.category;
            var page = this.page;
            this.set("catData.category", "default");
            this.set("pageData.page", "def-home");
            this.fire("openToast", {toastText: "That page is for admins only. Returned to default page."});
          }
        };
      },

      setRightMenuSelect: function() {
        if(this.page==="def-home"){
          this.rightMenuSelect = "home";
        } else {
          this.rightMenuSelect = null;
        };
      },

      toggleLoadingDisplay: function(page) {
        if(page === "def-home" && !this[page]) {
          this.enableDBLoading();
        } else {
          this.disableDBLoading();
        };
        if(page!="def-home" && !this[page]) {
          this.enablePageLoading();
        };
      },

      enableDBLoading: function() {
        this.customStyle["--db-loading-display"] = "flex";
        this.updateStyles();
      },

      disableDBLoading: function(e) {
        if(e){
          var page = e.detail.page
          this[e.detail.page] = true;
        };
        this.customStyle["--db-loading-display"] = "none";
        this.updateStyles();
      },

      enablePageLoading:function() {
        this.customStyle["--page-loading-active-color"] = "#FFEB3B";
        this.updateStyles();
      },

      pageFirstLoad: function(e) {
        if(e) {
          var page = e.detail.page
          this[e.detail.page] = true;
        };
        this.customStyle["--page-loading-active-color"] = "transparent";
        this.updateStyles();
        this.selected = this.page;
        this.ensureLayout(e.detail.page);
      },

      pageLoaded: function(page) {
        this.customStyle["--page-loading-active-color"] = "transparent";
        this.updateStyles();
        this.selected = this.page;
        this.ensureLayout(page);
      },

      lazyLoadPage: function(page) {
        // load page import on demand.
        var resolvedUrl = this.resolveUrl('pages/' + this.category + '/' + page + '.html');
        this.importHref (resolvedUrl, this.pageSuccess.apply(this, [page]), this.errorRedirect, true);
      },

      ensureLayout: function(page) {
        if(page.slice(0,3) === "def" || page.slice(0,2) === "ad" || page === "su-create") {
          this.$.appDrawerLayout.forceNarrow = true;
          this.$.appHeader.notifyResize();
          this.$.suDrawer.close();
        } else {
          this.$.appDrawerLayout.forceNarrow = false;
          this.$.appHeader.notifyResize();
        };
      },

      pageSuccess: function(page) {
        if(!this.currentCat) {
          this.currentCat = this.category;
        } else {
          this.currentCat = this.intendedCat;
          this.intendedCat = this.category;
        };
        //page loads are handled by even listener in pageFirstLoad() this handles subsequent loads...
        if(this[page]) {
          this.pageLoaded(page);
        };
      },

      resizeElements:function(){
        var neonOffsetTop=this.$.neonPages.offsetTop;
        var screenHeight=window.innerHeight;
        var headerHeight=this.$.appHeader.offsetHeight;
        this.customStyle["--neon-pages-height"]=screenHeight-headerHeight+"px";
        this.updateStyles();
      },

      errorRedirect: function() {
        this.set("category", "default");
        this.set("page", "def-error");
      },

      _middleware: function(page) {
        if(this.user) {
          this._checkVerified(this.user, this.statusKnown);
          this.checkAdmin();
        };
        this.enablePageLoading();
        this.setRightMenuSelect();
        //this.toggleLoadingDisplay(this.page);
        this.lazyLoadPage(this.page);
        //this.resizeElements();
      },
    };

  })();

</script>
