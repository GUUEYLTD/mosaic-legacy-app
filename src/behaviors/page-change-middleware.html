<link rel="import" href="../../bower_components/polymer/polymer.html" />

<script>

  (function(){
    "use-strict";
    /*
    @polymerBehavior Polymer.pageChangeMiddleware
    */
    Polymer.pageChangeMiddleware={
      is:"page-change-middleware",

      observers:[
        "_middleware(page)",
        "_userTypeReady(home, user)",
        "_authKnown(statusKnown)",
        "_checkVerified(user, statusKnown)"
      ],

      properties:{

        adTrialOver: {
          type: String,
          value: "Trial Period is over please update payment info to continue service usage."
        },

        swTrialOver: {
          type: String,
          value: "Trial Period is over please inform your supervisor that payment information must be updated in order to continue."
        },

        adNoPayment: {
          type: String,
          value: "Due to no payment, your accounts have been locked. Please update payment information in order to continue."
        },

        swNoPayment: {
          type: String,
          value: "Due to no payment, your account has been locked. Please inform your supervisor that valid payment information must be updated in order to continue."
        },

        noCoreText: {
          type: String,
          value: "It looks like your main service plan has been removed. If you feel this is in error, please contact support."
        },

        allowedPages: {
          type: Array,
          value: [
            "ad-support"
          ]
        }

      },

      //take in route as string and check against no auth routes
      authRequired:function(route){
        var noAuthRoutes=this.noAuthRoutes;
        if(noAuthRoutes.indexOf(route)===-1){
          return false;
        } else {
          return true;
        };
      },
      _authKnown:function(known){
        if(known===true){
          if(!this.$.auth.user && !this.authRequired(this.$.location.path)){
            window.location.href="/default/default/def-login";
          } else {
            if(this.user){
              this.$.userIndexDB.getStoredValue("/userIndex/"+this.user.uid+"/home")
                .then(function(value){
                  this.set('homeData.home', value);
                }.bind(this))
            };
          };
        };
      },

      _checkVerified: function(user, statusKnown) {
        if(statusKnown) {
          if(this.user && !this.user.emailVerified) {
            this.set("catData.category", "default");
            this.set("pageData.page", "def-verify");
          };
        };
      },

      pageAllowed: function(page) {
        return this.allowedPages.indexOf(page) !== -1;
      },

      _userTypeReady: function(home, user) {
        if(user && user.uid) {
          this.$.userTypeDB.path = "/homes/" + home + "/users/" + user.uid + "/role";
          this.$.userTypeDB.ref.on("value", function(snap) {
            this.currentUserType = snap.val();
            this.checkAdmin();
          }.bind(this));
        };
      },

      checkAdmin: function() {
        if(this.catData.category === "admin" && !this.pageAllowed(this.page)) {
          if(this.currentUserType === "admin" || this.currentUserType === "manager") {
            return;
          } else {
            var userType = this.currentUserType;
            var cat = this.catData.category;
            var page = this.page;
            this.set("catData.category", "default");
            this.set("pageData.page", "def-home");
            this.fire("openToast", {toastText: "That page is for admins only. Returned to default page."});
          }
        };
      },

      setRightMenuSelect: function() {
        if(this.page==="def-home"){
          this.rightMenuSelect = "home";
        } else {
          this.rightMenuSelect = null;
        };
      },

      paymentReroute: function() {
        this.$.paymentsDB.ref.once("value", function(snapshot) {
          var payments = snapshot.val();
          var core1 = false;
          for(x in payments) {
            if(payments[x].id === "core1"){
              core1 = payments[x];
            };
          };
          if(this.currentUserType) {
            //set restriction text for admins, managers, and others
            if(payments && payments.trial) {
              if(payments.trial.status === "canceled") {
                this.restrictToastText = this.adTrialOver;
                this.restrictDialogText = this.swTrialOver;
              };
            } else if(core1) {
              if(core1.status === "canceled") {
                this.restrictToastText = this.adNoPayment;
                this.restrictDialogText = this.swNoPayment;
              };
            } else {
              this.restrictDialogText = this.noCoreText;
              this.restrictToastText = this.noCoreText;
            };
            //handle restrictions for admins, managers, and others
            if(payments && payments.trial && payments.trial.status === "canceled" && (this.currentUserType === "admin" || this.currentUserType === "manager")) {
              this.set("catData.category", "admin");
              this.set("pageData.page", "ad-payment");
              this.fire("openToast", {toastText: this.restrictToastText});
            } else if(payments && payments.trial && payments.trial.status === "canceled") {
              this.$.lockedDialog.open();
            } else if(core1 && core1.status === "canceled" && (this.currentUserType === "admin" || this.currentUserType === "manager")) {
              this.set("catData.category", "admin");
              this.set("pageData.page", "ad-payment");
              this.fire("openToast", {toastText: this.restrictToastText});
            } else if(core1 && core1.status === "canceled"){
              this.$.lockedDialog.open();
            } else if(!core1 && (this.currentUserType === "admin" || this.currentUserType === "manager")) {
              this.set("catData.category", "admin");
              this.set("pageData.page", "ad-payment");
              this.fire("openToast", {toastText: this.restrictToastText});
            } else if(!core1) {
              this.$.lockedDialog.open();
            };
          };
        }.bind(this));
      },

      toggleLoadingDisplay: function(page) {
        if(page === "def-home" && !this[page]) {
          this.enableDBLoading();
        } else {
          this.disableDBLoading();
        };
        if(page!="def-home" && !this[page]) {
          this.enablePageLoading();
        };
      },

      enableDBLoading: function() {
        this.customStyle["--db-loading-display"] = "flex";
        this.updateStyles();
      },

      disableDBLoading: function(e) {
        if(e){
          var page = e.detail.page
          this[e.detail.page] = true;
        };
        this.customStyle["--db-loading-display"] = "none";
        this.updateStyles();
      },

      enablePageLoading:function() {
        this.customStyle["--page-loading-active-color"] = "#FFEB3B";
        this.updateStyles();
      },

      disablePageLoading: function(e) {
        if(e) {
          var page = e.detail.page
          this[e.detail.page] = true;
        };
        this.customStyle["--page-loading-active-color"] = "transparent";
        this.updateStyles();
      },

      lazyLoadPage: function(page) {
        // load page import on demand.
        this.importHref (
          this.resolveUrl ('pages/' + this.category + '/' + page + '.html'),
          function() {
            if(!this.currentCat) {
              this.currentCat = this.category;
            } else {
              this.currentCat = this.intendedCat;
              this.intendedCat = this.category;
            };
            this.selected = this.page;
            this.ensureLayout(page);
          },
          function(){
            this.errorRedirect();
          }, false);
      },

      ensureLayout: function(page) {
        if(page.slice(0,3) === "def" || page.slice(0,2) === "ad" || page === "su-create") {
          this.$.appDrawerLayout.forceNarrow = true;
          this.$.appHeader.notifyResize();
          this.$.suDrawer.close();
        } else {
          this.$.appDrawerLayout.forceNarrow = false;
          this.$.appHeader.notifyResize();
        };
      },

      errorRedirect: function() {
        this.set("catData.category", "default");
        this.set("pageData.page", "def-error");
      },

      _middleware: function(page) {
        if(this.user) {
          this._checkVerified(this.user, this.statusKnown);
          this.checkAdmin();
          this.paymentReroute();
        };
        this.setRightMenuSelect();
        this.toggleLoadingDisplay(this.page);
        this.lazyLoadPage(this.page);
        this.resizeElements();
      },
    };

  })();

</script>
