cd<link rel="import" href="../bower_components/polymer/polymer.html" />
<link rel="import" href="../bower_components/polymerfire/firebase-app.html" />
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html" />
<link rel="import" href="../bower_components/polymerfire/firebase-document.html" />
<link rel="import" href="../bower_components/polymerfire/firebase-query.html" />
<link rel="import" href="../bower_components/app-route/app-location.html" />
<link rel="import" href="../bower_components/app-route/app-route.html" />
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html" />
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html" />
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html" />
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html" />
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html" />
<link rel="import" href="../bower_components/paper-badge/paper-badge.html" />
<link rel="import" href="../bower_components/iron-pages/iron-pages.html" />
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html" />
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html" />
<link rel="import" href="../bower_components/paper-item/paper-item.html" />
<link rel="import" href="../bower_components/paper-item/paper-item-body.html" />
<link rel="import" href="../bower_components/iron-selector/iron-selector.html" />
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html" />
<link rel="import" href="../bower_components/iron-icon/iron-icon.html" />
<link rel="import" href="../bower_components/iron-icons/iron-icons.html" />
<link rel="import" href="../bower_components/iron-icons/social-icons.html" />
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html" />
<link rel="import" href="../bower_components/paper-toast/paper-toast.html" />
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html" />
<link rel="import" href="../bower_components/paper-progress/paper-progress.html" />
<link rel="import" href="../bower_components/paper-input/paper-input.html" />
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html" />
<link rel="import" href="../bower_components/paper-button/paper-button.html" />
<link rel="import" href="../bower_components/neon-animation/neon-animated-pages.html" />
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html" />
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html" />
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html" />

<link rel="import" href="elements/admin-drawer/admin-drawer.html" />
<link rel="import" href="elements/firebase-storage/firebase-storage.html" />
<link rel="import" href="elements/guuey-bug-report/guuey-bug-report.html" />
<link rel="import" href="elements/media-queries/media-queries.html" />
<link rel="import" href="elements/guuey-notification/guuey-notification.html" />
<link rel="import" href="elements/guuey-account-display/guuey-account-display.html" />

<link rel="import" href="behaviors/shell-resize-behavior.html" />
<link rel="import" href="behaviors/page-change-middleware.html" />
<link rel="import" href="behaviors/account-create-behavior.html" />

<link rel="import" href="styles/app-shell-styles.html" />

<link rel="import" href="icons/custom-icons.html" />
<link rel="import" href="icons/module-icons.html" />


<dom-module id="my-app">

  <template>
    <media-queries
      dimensions="{{dimensions}}">
    </media-queries>

    <iron-localstorage
      id="recentUsers"
      name="recent-users"
      on-iron-localstorage-load-empty="_initializeRecentUsers">
    </iron-localstorage>
    <!--firebase app and auth config-->
    <firebase-app
      name="main"
      auth-domain="careplan-c2677.firebaseapp.com"
      database-url="https://careplan-c2677.firebaseio.com"
      api-key="AIzaSyBdtmHIV_7epC0OBiXkTNoqrGRspA58Epc"
      storage-bucket="careplan-c2677.appspot.com">
    </firebase-app>
    <!--SECONDARY APP FOR GETTING AROUND USER AUTO SIGN IN WHEN CREATING A NEW USER-->
    <firebase-app
      name="user2"
      auth-domain="careplan-c2677.firebaseapp.com"
      database-url="https://careplan-c2677.firebaseio.com"
      api-key="AIzaSyBdtmHIV_7epC0OBiXkTNoqrGRspA58Epc">
    </firebase-app>
    <firebase-auth
      id="auth"
      app-name="main"
      user="{{user}}"
      signed-in="{{signedIn}}"
      status-known="{{statusKnown}}"
      on-error="handleError">
    </firebase-auth>
    <!--NEED TO PUT THIS SOMEWHERE ELSE LATER ONLY USED TO CREATE NEW USERS-->
    <firebase-auth
      id="createUser"
      app-name="user2"
      user="{{newUser}}">
    </firebase-auth>
    <firebase-storage
      id="storage"
      app-name="main"
      set-name="false"
      path="uploads/[[home]]/home-image.png"
      use64="true"
      url="{{homeImage}}">
    </firebase-storage>
    <!--MOVE THIS WHEN REFACTORING CODE DOES NOT BELONG HERE!-->
    <firebase-document
      id="userDB"
      app-name="main">
    </firebase-document>
    <firebase-document
      id="userTypeDB"
      app-name="main">
    </firebase-document>
    <!--SAME AS ABOVE MOVE LATER USED TO GET PROFILE INFO FOR SIDEBAR-->
    <firebase-document
      path="/homes/[[home]]/details"
      data="{{careHomeProfile}}"
      app-name="main">
    </firebase-document>
    <!--firebase doc to create new home... NEEDS TO GO ELSEWHERE LATER!-->
    <firebase-document
      id="homeDB"
      app-name="main">
    </firebase-document>

    <firebase-document
      id="userIndexDB"
      app-name="main">
    </firebase-document>

    <firebase-document
      id="homeIndexDB"
      app-name="main">
    </firebase-document>

    <firebase-document
      id="notifiableDB"
      app-name="main">
    </firebase-document>

    <firebase-query
      id="paymentsDB"
      app-name="main"
      path="/payments/[[home]]"
      data="{{payments}}">
    </firebase-query>

    <firebase-query
      id="notifyDB"
      path="/homes/[[home]]/notifications/notify"
      data="{{notifiesData}}"
      app-name="main">
    </firebase-query>

    <firebase-query
      id="suIndexDB"
      path="/homes/[[home]]/patients/suIndex"
      data="{{suList}}"
      app-name="main">
    </firebase-query>
    <!--routing config-->
    <app-location id="location" route="{{route}}"></app-location>
    <!--route to declare which home is being accessed-->
    <app-route
      route="{{route}}"
      pattern="/:home"
      data="{{homeData}}"
      tail="{{catRoute}}">
    </app-route>
    <!--route for page dir (category of page)-->
    <app-route
      route="{{catRoute}}"
      pattern="/:category"
      data="{{catData}}"
      tail="{{pageRoute}}">
    </app-route>
    <!--route for page name-->
    <app-route
      route="{{pageRoute}}"
      pattern="/:page"
      data="{{pageData}}"
      tail="{{paramRoute}}">
    </app-route>
    <!--final param for multi use (patientid, careworkerid etc...)-->
    <app-route
      route="{{paramRoute}}"
      pattern="/:param"
      data="{{paramData}}">
    </app-route>
    <style include="app-shell-styles"></style>

    <paper-dialog id="appsDialog">
      <div class="flexRow">
        <paper-icon-button icon="modules:care-plan"></paper-icon-button>
        <paper-icon-button icon="modules:adv-care"></paper-icon-button>
        <paper-icon-button icon="modules:medication"></paper-icon-button>
      </div>
      <div class="flexRow">
        <paper-icon-button icon="modules:training"></paper-icon-button>
        <paper-icon-button icon="modules:health-safety"></paper-icon-button>
        <paper-icon-button icon="modules:policies-procedures"></paper-icon-button>
      </div>
      <div class="flexRow">
        <paper-icon-button icon="modules:analytics"></paper-icon-button>
        <paper-icon-button icon="modules:communication"></paper-icon-button>
        <paper-icon-button icon="modules:reporting"></paper-icon-button>
      </div>
      <div class="flexRow">
        <paper-icon-button icon="modules:staff-manager"></paper-icon-button>
        <paper-icon-button icon="modules:administration"></paper-icon-button>
        <paper-icon-button icon="modules:meals"></paper-icon-button>
      </div>
    </paper-dialog>

    <paper-dialog id="notifyDialog">
      <paper-dialog-scrollable id="notifyDialogScroll">

        <template is="dom-repeat" items="[[notifiesData]]" as="guueyNotify">

            <guuey-notification index="[[index]]" info="[[guueyNotify]]"></guuey-notification>

        </template>

      </paper-dialog-scrollable>
    </paper-dialog>

    <paper-dialog id="logoutDialog">
      <guuey-account-display
        user-image="[[_computeUserPhoto(user.photoURL)]]"
        display-name="[[_computeDisplayName(user.displayName)]]"
        user-email="[[user.email]]"
        home="[[home]]"
        on-tap="closeLogout">
      </guuey-account-display>
    </paper-dialog>

    <paper-dialog modal id="lockedDialog">
      <p>
        [[restrictDialogText]]
      </p>
    </paper-dialog>

    <div class="loadingOverlay">
      <paper-spinner-lite active></paper-spinner-lite>
      <p>
        Just a minute... Content Loading...
      </p>
    </div>
    <div class="loginOverlay"></div>

    <guuey-bug-report home="[[home]]" page="[[page]]" patient="[[param]]" user="[[user]]"></guuey-bug-report>

    <app-drawer-layout responsive-width="1023px" fullbleed id="appDrawerLayout">

      <!--admin drawer that contains admin account info and functions-->
      <admin-drawer
        id="adminDrawer"
        home="[[home]]"
        admin="[[param]]"
        email="[[user.email]]"
        user-type="[[currentUserType]]"
        opened="{{opened}}"
        allowed-pages="[[allowedPages]]">
      </admin-drawer>
      <!--second drawer to contain target info links (company service user etc...) link up to db later-->
      <app-drawer align="end" id="suDrawer" swipe-open>
        <iron-image id="suDrawerImage"
          placeholder="../../../../images/default_home.png"
          preload
          fade
          sizing="cover"
          src="[[homeImage]]">
        </iron-image>

        <div class="moduleInfo">
          <iron-image id="moduleType"
            sizing="contain"
            src="../images/care-plan-icon.png">
          </iron-image>
          <p class="moduleTypeLabel">
            care plan
          </p>
        </div>

        <div class="divider"></div>

        <iron-selector selected="[[page]]" attr-for-selected="name" class="drawer-list" role="navigation">
          <a on-tap="closeDrawer" name="su-profile" href="/[[home]]/care-plan/su-profile/[[param]]">Personal Profile<a>
          <a on-tap="closeDrawer" name="su-reports" href="/[[home]]/care-plan/su-reports/[[param]]">Daily Reports</a>
          <a on-tap="closeDrawer" name="su-pre" href="/[[home]]/care-plan/su-pre/[[param]]">Pre-Admission Assessment</a>
          <a on-tap="closeDrawer" name="su-care" href="/[[home]]/care-plan/su-care/[[param]]">Care Plan</a>
          <a on-tap="closeDrawer" name="su-care-review" href="/[[home]]/care-plan/su-care-review/[[param]]">Care Plan Review</a>
          <a on-tap="closeDrawer" name="su-medical" href="/[[home]]/care-plan/su-medical/[[param]]">Medical Assessment</a>
          <a on-tap="closeDrawer" name="su-medication" href="/[[home]]/care-plan/su-medication/[[param]]">Medication Outline</a>
          <a on-tap="closeDrawer" name="su-risk" href="/[[home]]/care-plan/su-risk/[[param]]">Risk Assessment</a>
          <a on-tap="closeDrawer" name="su-goals" href="/[[home]]/care-plan/su-goals/[[param]]">Personal Goals</a>
          <a on-tap="closeDrawer" name="su-monthly-reports" href="/[[home]]/care-plan/su-monthly-reports/[[param]]">Monthly Reports</a>
          <a on-tap="closeDrawer" name="su-view-reports" href="/[[home]]/care-plan/su-view-reports/[[param]]">View Reports</a>
        </iron-selector>

      </app-drawer>

      <!-- Main content -->
      <app-header-layout fullbleed>

        <app-header id="appHeader" condenses reveals effects="waterfall">
          <paper-progress class="mainProgress" indeterminate></paper-progress>


          <app-toolbar id="mobileMenu" class="mobileMainToolbar">
            <paper-tabs id="mobileTabs" class="rightMenuTabs" attr-for-selected="name" selected="{{rightMenuSelect}}" style="height:100%;">
              <paper-tab class="mobileTab" name="home"><a class="inherit mobileToolbarInner" href="/[[home]]/default/def-home"><iron-icon icon="icons:home"></iron-icon></a></paper-tab>
              <paper-tab class="mobileTab" on-tap="openApps" name="apps"><iron-icon icon="icons:apps"></iron-icon></paper-tab>
              <paper-tab class="mobileTab" on-tap="openNotifications" name="notify">

                <iron-icon class="dropdown-trigger" icon="social:notifications"></iron-icon>
                <span id="notifyCount" class="notifyCount" hidden="{{computeNotifyHidden(notifyCount)}}">
                  <span class="notifyContent">
                  [[notifyCount]]
                  </span>
                </span>

              </paper-tab>
              <paper-tab class="mobileTab" name="logout"><iron-icon on-tap="openLogout" icon="icons:account-circle"></iron-icon></paper-tab>
            </paper-tabs>
          </app-toolbar>

          <app-toolbar id="mobileMenu" class="mobileAltToolbar">
            <paper-icon-button class="mobileToolbarButton" icon="menu" on-tap="toggleDrawer"></paper-icon-button>

            <div class="toolbarInner">

              <paper-icon-button icon="icons:search" on-tap="toggleMobileSearch"></paper-icon-button>

              <iron-collapse id="mobileSearch" horizontal>
                <paper-input label="search" value="{{searchVal}}"></paper-input>
              </iron-collapse>

            </div>
            <paper-icon-button class="mobileToolbarButton" icon="custom:su-drawer" on-tap="toggleRightDrawer"></paper-icon-button>

            <iron-collapse id="mobileSearchDropdown">

              <template
                is="dom-repeat"
                items="[[suList]]"
                as="search"
                filter="{{mobileSearchFilter(searchVal)}}"
                observe="fName lName"
                initial-count="10">
                  <a class="dropdownLinks" href="/[[home]]/care-plan/su-profile/[[search.$key]]" on-tap="hideSearch">
                    <paper-item class="dropdownItem">[[search.fName]] [[search.lName]]</paper-item>
                  </a>
              </template>

            </iron-collapse>

          </app-toolbar>

          <app-toolbar id="desktopMenu">

            <div class="toolbarLeft">
              <paper-icon-button class="leftToolbarButton" icon="menu" on-tap="toggleDrawer"></paper-icon-button>
              <span class="menuText">menu</span>

              <div class="searchInput">
                <span hidden="[[searchVal]]">
                  <paper-icon-button class="leftToolbarButton" icon="icons:search"></paper-icon-button>
                </span>
                <span hidden="[[!searchVal]]">
                  <paper-icon-button class="leftToolbarButton" icon="icons:clear" on-tap="clearSearch"></paper-icon-button>
                </span>
                <input style="display:inline-block;" type="text" value="{{searchVal::input}}" />
              </div>

            </div>

            <div class="toolbarRight">

              <paper-tabs class="rightMenuTabs" attr-for-selected="name" selected="{{rightMenuSelect}}" style="height:100%;">
                <paper-tab class="desktopTab" name="home"><a class="inherit mobileToolbarInner" href="/[[home]]/default/def-home"><iron-icon icon="icons:home"></iron-icon></a></paper-tab>
                <paper-tab class="desktopTab" id="appButton" name="apps" on-tap="openApps"><iron-icon icon="icons:apps"></iron-icon></paper-tab>
                <paper-tab  class="desktopTab" id="notifyButton" name="notify" on-tap="openNotifications">

                  <iron-icon icon="social:notifications"></iron-icon>
                  <span id="notifyCount" class="notifyCount" hidden="{{computeNotifyHidden(notifyCount)}}">
                    <span class="notifyContent">
                    [[notifyCount]]
                    </span>
                  </span>

                </paper-tab>
                <paper-tab class="desktopTab" name="logout" on-tap="openLogout"><iron-icon icon="icons:account-circle"></iron-icon></paper-tab>
              </paper-tabs>

            </div>

            <iron-collapse id="searchDropdown">

              <template
                is="dom-repeat"
                items="[[suList]]"
                as="search"
                filter="{{searchFilter(searchVal)}}"
                observe="fName lName"
                initial-count="10">
                  <a class="dropdownLinks" href="/[[home]]/care-plan/su-profile/[[search.$key]]" on-tap="hideSearch">
                    <paper-item class="dropdownItem">[[search.fName]] [[search.lName]]</paper-item>
                  </a>
              </template>

            </iron-collapse>

          </app-toolbar>
        </app-header>
        <!--page templates are loded in here inside iron pages-->
        <neon-animated-pages id="neonPages"
          role="main"
          selected="[[selected]]"
          attr-for-selected="name">
          <!--custom pages built for the app names attached in order to know which to display according to route-->
          <!--page selected style only shows when the drawer item has been clicked twice need to fix this..-->
          <!--login page-->
          <def-login
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            name="def-login">
          </def-login>
          <!--default page-->
          <def-home
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            home="[[home]]"
            name="def-home"
            signed-in="[[signedIn]]">
          </def-home>
          <!--default page if not verified-->
          <def-verify
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            home="[[home]]"
            name="def-verify">
          </def-verify>
          <def-account
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            home="[[home]]"
            name="def-account">
          </def-account>
          <!--error 404 page-->
          <def-error
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            name="def-error">
          </def-error>
          <!--other pages for care plan-->
          <su-home
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            patient="[[param]]"
            home="[[home]]"
            name="su-home">
          </su-home>
          <su-profile
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            patient="[[param]]"
            home="[[home]]"
            name="su-profile">
          </su-profile>
          <su-care
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            patient="[[param]]"
            home="[[home]]"
            name="su-care">
          </su-care>
          <su-goals
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            patient="[[param]]"
            home="[[home]]"
            name="su-goals">
        </su-goals>
          <!--add in user in order to log the uid for version control and logging-->
          <su-medical
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            patient="[[param]]"
            home="[[home]]"
            user="{{user}}"
            name="su-medical">
          </su-medical>
          <!--add in user in order to log the uid for version control and logging-->
          <su-medication
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            patient="[[param]]"
            home="[[home]]"
            user="{{user}}"
            name="su-medication">
          </su-medication>
          <su-pre
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            patient="[[param]]"
            home="[[home]]"
            name="su-pre">
          </su-pre>
          <su-profile
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            patient="[[param]]"
            home="[[home]]"
            name="su-profile">
          </su-profile>
          <!--add in user in order to log the uid for version control and logging-->
          <su-risk
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            patient="[[param]]"
            home="[[home]]"
            user="{{user}}"
            name="su-risk">
          </su-risk>
          <su-create
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            patient="[[param]]"
            home="[[home]]"
            name="su-create">
          </su-create>
          <su-care-review
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            patient="[[param]]"
            home="[[home]]"
            name="su-care-review">
          </su-care-review>
          <su-reports
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            patient="[[param]]"
            home="[[home]]"
            name="su-reports">
          </su-reports>
          <su-monthly-reports
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            patient="[[param]]"
            home="[[home]]"
            name="su-monthly-reports">
          </su-monthly-reports>
          <su-view-reports
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            patient="[[param]]"
            home="[[home]]"
            name="su-view-reports">
          </su-view-reports>
          <!--pages for admin-->
          <ad-dash
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            admin-id="[[param]]"
            home="[[home]]"
            name="ad-dash">
          </ad-dash>
          <ad-profile
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            admin-id="[[param]]"
            home="[[home]]"
            name="ad-profile">
          </ad-profile>
          <ad-payment
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            admin-id="[[param]]"
            home="[[home]]"
            name="ad-payment">
          </ad-payment>
          <ad-users
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            admin-id="[[param]]"
            user={{user}}
            home="[[home]]"
            name="ad-users">
          </ad-users>
          <ad-user
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            uid="[[param]]"
            user={{user}}
            home="[[home]]"
            name="ad-user">
          </ad-user>
          <ad-settings
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            admin-id="[[param]]"
            home="[[home]]"
            name="ad-settings">
          </ad-settings>
          <ad-support
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            admin-id="[[param]]"
            home="[[home]]"
            name="ad-support">
          </ad-support>
          <ad-reports
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            admin-id="[[param]]"
            home="[[home]]"
            name="ad-reports">
          </ad-reports>
          <!--test page for whatever-->
          <test-test
            current-page="[[currentPage]]"
            current-cat="[[currentCat]]"
            intended-cat="[[intendedCat]]"
            page="[[page]]"
            patient="[[param]]"
            home="[[home]]"
            name="test-test">
          </test-test>
        </neon-animated-pages>

      </app-header-layout>

    </app-drawer-layout>

    <paper-toast
      id="mainToast"
      class="fit-bottom"
      duration="15000">
      <paper-button on-tap="_closeToast">close</paper-button>
    </paper-toast>

  </template>

  <script>

    Polymer({

      is:'my-app',
      getElement:function(name){
        return this.$$(name);
      },
      //event listener for user creation
      ready:function(){
        this.addEventListener('createNewUser', this.createNewUser);
        this.addEventListener('saveNewUser', this.saveNewUser);
        this.addEventListener('createNewAccount', this.createNewAccount);
        this.addEventListener('signInRedirect', this.signInRedirect);
        this.addEventListener('addUserToHomeIndex', this.addUserToHomeIndex);
        this.addEventListener('addUserToIndex', this.addUserToIndex);
        this.addEventListener('emailSignIn',this.emailSignIn);
        this.addEventListener('openToast', this.openToast);
        this.addEventListener('openDrawer', this.openDrawer);
        this.addEventListener('dbLoading', this.enableDBLoading);
        this.addEventListener('dbLoaded', this.disableDBLoading);
        this.addEventListener('pageLoading', this.enablePageLoading);
        this.addEventListener('pageLoaded', this.disablePageLoading);
        this.addEventListener('dismissNotification',this.dismissNotification);
        this.addEventListener('checkNotification', this.checkNotification);
        this.addEventListener('app-drawer-transitioned', this.resizeDrawerImage);
        this.addEventListener('logout', this.logout);
        this.addEventListener('cancelLogout', this.cancelLogout);
        this.fire("pageLoaded",{page:this.page});
        this.addEventListener("resize", this.resizeElements);
        this.$.storage._downloadFile(this.$.storage.path);
      },
      attached:function(){
        this.resizeElements();
      },
      resizeElements:function(){
        var neonOffsetTop=this.$.neonPages.offsetTop;
        var screenHeight=window.innerHeight;
        var headerHeight=this.$.appHeader.offsetHeight;
        this.customStyle["--neon-pages-height"]=screenHeight-headerHeight+"px";
        if(this.page==="def-login"){
          this.customStyle["--login-overlay-display"]="inline-block";
          this.customStyle["--login-overlay-height"]=headerHeight+"px";
        } else {
          this.customStyle["--login-overlay-display"]="none";
          this.customStyle["--login-overlay-height"]="0px";
        };
        this.updateStyles();
      },
      //create new service user for an already existing home
      createNewUser:function(e){
        var password=this.makePass();
        this.$.createUser.createUserWithEmailAndPassword(e.detail.username, password)
          .then(function(user){
            user.updateProfile({
              displayName: e.detail.fName+" "+e.detail.lName
            }).then(function() {
              this.fire("openToast",{toastText: "New User display name updated."});
            }.bind(this), function(error) {
              this.fire("openToast",{toastText: error});
            }.bind(this));
            var userEntry={
              userUID:user.uid,
              username:user.email,
              displayName:e.detail.fName+" "+e.detail.lName,
              role:e.detail.role,
              home:this.home,
            };
            //patients and role
            if(e.detail.patients){
              userEntry.patients=e.detail.patients;
            };
            this.fire("saveNewUser", userEntry);
          }.bind(this))
          .catch(function(error){
            this.fire("openToast", {toastText:error});
          }.bind(this));
      },
      //save the new user to the db... probably should put into other function.... (createNewSU)
      saveNewUser:function(e){
        this.$.userDB.path=null;
        this.$.userDB.data={
          email: e.detail.username,
          role: e.detail.role,
          home: e.detail.home,
          displayName:e.detail.displayName
        };
        if(e.detail.patients){
          this.$.userDB.data.patients=e.detail.patients;
        };
        this.$.userDB.save('/homes/'+this.home+'/users', e.detail.userUID)
          .then(function(){
            var indexData={
              home:e.detail.home,
              userUID:e.detail.userUID
            };
            this.fire('addUserToIndex',indexData);
          }.bind(this))
          .catch(function(error){
            this.fire("openToast",{toastText:error});
          });
      },
      //add the user to the admin user index in the home
      addUserToIndex:function(e){
        this.$.userIndexDB.path=null;
        this.$.userIndexDB.data.home=e.detail.home;
        this.$.userIndexDB.save('/userIndex', e.detail.userUID);
        var userEmail=this.$.userDB.data.email;
        this.$.createUser.auth.sendPasswordResetEmail(userEmail)
          .then(function() {
          this.fire("openToast",{toastText:"Verification email sent to new user with email address: "+userEmail+"."});
          }.bind(this), function(error) {
          this.fire("openToast",{toastText:error});
          console.log(error);
          }.bind(this));
        this.$.createUser.signOut();
        this.$.userDB.path=null;
        this.$.userDB.data={};
      },
      makePass:function(){
          var text = "";
          var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@$?%^&*()";

          for( var i=0; i < 10; i++ )
              text += possible.charAt(Math.floor(Math.random() * possible.length));

          return text;
      },
      properties:{
        rightMenuSelect:{
          type:String,
          value:"home"
        },
        home:{
          type:String,
          reflectToAttribute:true,
          observer:'_homeChanged',
          value:'default',
        },
        intendedCat:{
          type:String,
          value:'default'
        },
        category:{
          type:String,
          reflectToAttribute:true,
          observer:'_catChanged',
          value:'default',
        },
        page:{
          type:String,
          reflectToAttribute:true,
        },
        param:{
          type:String,
          reflectToAttribute:true,
          observer:'_paramChanged'
        },
        login:{
          type:Object,
        },
        payments:{
          type:Object,
        },
        //routes that do not get overriden by not being logged in
        noAuthRoutes:{
          type:Array,
          value:[
            "/default/default/def-verify",
            "/default/default/def-login"
            ]
        }
      },
      //routing config
      observers: [
        '_homeRouteChanged(homeData.home)',
        '_catRouteChanged(catData.category)',
        '_pageRouteChanged(pageData.page)',
        '_paramRouteChanged(paramData.param)',
        '_authKnown(statusKnown)',
        '_computeNotificationCount(notifiesData)',
        '_computeNotifyDialogHidden(notifiesData.*)',
        '_userChanged(user)'
      ],
      _userChanged:function(user){
        var userExists = true;
        if(this.$.recentUsers.value){
          var userExists = this.$.recentUsers.value.some(function(existingUser){
            return existingUser.email === user.email ? true : false;
          });
        };
        if(user && !userExists){
          var newRecentUser = {
            displayName:user.displayName,
            email:user.email,
            photoURL:user.photoURL
          };
          this.$.recentUsers.value.push(newRecentUser);
          this.$.recentUsers.save();
        };
      },
      behaviors: [
        Polymer.shellResizeBehavior,
        Polymer.pageChangeMiddleware,
        Polymer.accountCreateBehavior
      ],
      _homeRouteChanged:function(home){
        this.home=home || 'default';
      },
      _catRouteChanged:function(category){
        this.category = category || 'default';
      },
      _pageRouteChanged:function(page) {
          this.currentPage=this.page;
          this.page=page || 'def-home';
      },
      _paramRouteChanged:function(param){
        this.param = param || '';
      },
      _homeChanged:function(home){
        if(home!='default'){
          this.home=this.homeData.home;
        }
      },
      _catChanged:function(cat){
        //make an exception for the default category 'default' if not default track changes to cat
        if(cat!='default'){
          this.category=this.catData.category;
        }
      },
      _paramChanged:function(param){
        this.param=this.paramData.param || '';
        this.searchVal="";
      },
      //workaround for toggle-drawer bug
      toggleDrawer:function(){
        this.$.adminDrawer.opened=!this.$.adminDrawer.opened;
      },
      toggleRightDrawer:function(){
        this.$.suDrawer.toggle();
      },
      //sign in that redirects based on user uid and user index with homes attached
      emailSignIn:function(e){
        this.$.auth.signInWithEmailAndPassword(e.detail.username, e.detail.password)
          .then(function(user){
            this.$.userIndexDB.getStoredValue("/userIndex/"+user.uid+"/home")
              .then(function(value){
                window.location="/"+value+"/default/def-home";
              }.bind(this))
            //this.fire('signInRedirect');
          }.bind(this))
          .catch(function(error){
            this.$.mainToast.text=error;
            this.$.mainToast.open()
          }.bind(this));
      },
      logout:function(){
        this.$.auth.signOut();
        window.location="/default/default/def-login";
      },
      cancelLogout:function(){
        this.$.logoutDialog.close();
      },
      //other stuff
      handleError:function(error){
      },
      _patientSelected:function(category, param){
        if((this.category==="care-plan" || "test") && this.param){
          return true;
        } else {
          return false;
        };
      },
      loginPageInactive:function(page){
        if(page!="def-login"){
          return true;
        };
      },
      goHome:function(){
        this.set("catData.category", "default");
        this.set("pageData.page", "def-home");
        //window.location="/"+this.home+"/default/def-home";
      },
      goBack:function(){
        window.history.back();
      },
      //take in route as string and check against no auth routes
      authRequired:function(route){
        var noAuthRoutes=this.noAuthRoutes;
        if(noAuthRoutes.indexOf(route)===-1){
          return false;
        } else {
          return true;
        };
      },
      _authKnown:function(known){
        if(known===true){
          if(this.user){
            this.$.userTypeDB.getStoredValue("/homes/"+this.home+"/users/"+this.user.uid+"/role")
              .then(function(userType){
                this.currentUserType=userType;
                if(userType==="admin" && !this.user.emailVerified){
                  this.set("catData.category", "default");
                  this.set("pageData.page", "def-verify");
                }
              }.bind(this));
          }
          if(!this.$.auth.user && !this.authRequired(this.$.location.path)){
            window.location.href="/default/default/def-login";
          } else {
            if(this.user){
              this.$.userIndexDB.getStoredValue("/userIndex/"+this.user.uid+"/home")
                .then(function(value){
                  this.set('homeData.home', value);
                }.bind(this))
            };
          };
        };
      },
      _computeDrawerHidden:function(page){
        if(page.slice(0,3)==="def" || page.slice(0,2)==="ad"){
          return true;
        } else {
          return false;
        }
      },
      openToast:function(e){
        this.$.mainToast.text=e.detail.toastText;
        this.$.mainToast.open();
      },
      _closeToast:function(){
        this.$.mainToast.close();
      },
      openDrawer:function(){
        this.$.suDrawer.open();
      },
      closeDrawer:function(){
        if(this.dimensions.query1023){
          this.$.suDrawer.close();
        };
      },
      _computeNotificationCount:function(notifiesData){
        var count;
        this.$.notifyDB.query
          .on("value",function(snapshot){
            count=snapshot.numChildren();
            this.notifyCount=count;
          }.bind(this));
      },
      _computeNotifyDialogHidden:function(count){
        if(count.base.length<1){
          this.$.notifyDialog.close();
          this.$.notifyCount.style="opacity:0;";
        } else {
          this.$.notifyCount.style="opacity:1;";
        };
      },
      dismissNotification:function(e){
        var key = e.detail.data.$key;
        var data = e.detail.data;
        var index = e.detail.index;
        delete data.$key;
        this.$.notifiableDB.path=null;
        this.$.notifiableDB.data=data;
        this.$.notifiableDB.save("/homes/"+this.home+"/notifications/notified", key)
          .then(function(){
            this.$.notifiableDB.path="/homes/"+this.home+"/notifications/notify/"+key;
            this.$.notifiableDB.destroy()
              .then(function(){
                this.notifyPath("notifiesData");
              }.bind(this));
          }.bind(this));
      },
      computeNotifyHidden:function(count){
        if(count<1){
          return true;
        } else {
          return false;
        }
      },
      searchFilter:function(val){
        if(val.length<3){
          this.$.searchDropdown.hide();
          return null;
        } else {
          var val=val.toLowerCase();
          this.$.searchDropdown.show();
          return function(search){
            var fName=search.fName.toLowerCase();
            var lName=search.lName.toLowerCase();
            return fName.indexOf(val) != -1 ||
            lName.indexOf(val) != -1;
          };
        };
      },
      mobileSearchFilter:function(val){
        if(val.length<3){
          this.$.mobileSearchDropdown.hide();
          return null;
        } else {
          var val=val.toLowerCase();
          this.$.mobileSearchDropdown.show();
          return function(search){
            var fName=search.fName.toLowerCase();
            var lName=search.lName.toLowerCase();
            return fName.indexOf(val) != -1 ||
            lName.indexOf(val) != -1;
          };
        };
      },
      clearSearch:function(){
        this.searchVal="";
      },
      hideSearch:function(){
        this.$.searchDropdown.hide();
      },
      showNotifications:function(){
        this.$.notificationDropdown.toggle();
      },
      showMobileNotifications:function(){
        this.$.mobileNotificationDropdown.toggle();
      },
      toggleMobileSearch:function(){
        this.$.mobileSearch.toggle();
      },
      openApps:function(e){
        // hypotenuse of 45 degree rotated square that is before the dialog... meaning the width in relative terms
        var isMobile = e.currentTarget.classList.contains("mobileTab");
        var isDesktop = e.currentTarget.classList.contains("desktopTab");
        var beforeWidth = Math.sqrt(Math.pow(20, 2) + Math.pow(20, 2));
        var containedIcon = Polymer.dom(e.currentTarget).children[0];
        if(isMobile) {
          this.$.appsDialog.positionTarget = containedIcon;
          this.$.appsDialog.verticalAlign = "top";
          this.$.appsDialog.horizontalAlign = "left";
          this.$.appsDialog.noOverlap = true;
          this.$.appsDialog.horizontalOffset = -e.currentTarget.offsetLeft - 12;
          this.$.appsDialog.classList.remove("dialogPointer");
          this.$.appsDialog.style = "width:100%;";
        };

        if(isDesktop) {
          this.$.appsDialog.positionTarget = e.currentTarget;
          this.$.appsDialog.verticalAlign = "top";
          this.$.appsDialog.horizontalAlign = "right";
          this.$.appsDialog.noOverlap = true;
          this.$.appsDialog.horizontalOffset = (e.currentTarget.offsetWidth / 2) - beforeWidth;
          this.$.appsDialog.classList.add("dialogPointer");
          this.$.appsDialog.style = "";
        };
        this.$.logoutDialog.close();
        this.$.notifyDialog.close();
        this.$.appsDialog.toggle();
      },
      openNotifications:function(e){
        // hypotenuse of 45 degree rotated square that is before the dialog... meaning the width in relative terms
        var isMobile = e.currentTarget.classList.contains("mobileTab");
        var isDesktop = e.currentTarget.classList.contains("desktopTab");
        var beforeWidth = Math.sqrt(Math.pow(20, 2) + Math.pow(20, 2));
        var containedIcon = Polymer.dom(e.currentTarget).children[0];
        if(isMobile) {
          this.$.notifyDialog.positionTarget = containedIcon;
          this.$.notifyDialog.verticalAlign = "top";
          this.$.notifyDialog.horizontalAlign = "left";
          this.$.notifyDialog.noOverlap = true;
          this.$.notifyDialog.classList.remove("dialogPointer");
          //where is this extra 12 coming from??? should fix this later...
          this.$.notifyDialog.horizontalOffset = -e.currentTarget.offsetLeft - 12;
        };

        if(isDesktop) {
          this.$.notifyDialog.positionTarget = e.currentTarget;
          this.$.notifyDialog.verticalAlign = "top";
          this.$.notifyDialog.horizontalAlign = "right";
          this.$.notifyDialog.noOverlap = true;
          this.$.notifyDialog.classList.add("dialogPointer");
          this.$.notifyDialog.horizontalOffset = (e.currentTarget.offsetWidth / 2) - beforeWidth;
        };

        this.$.notifyDialogScroll.dialogElement = this.$.notifyDialog;
        if(this.notifiesData.length<1){
          return;
        };
        this.$.appsDialog.close();
        this.$.logoutDialog.close();
        this.$.notifyDialog.toggle();
      },
      checkNotification:function(){
        this.$.notifyDialog.close();
      },
      openLogout:function(e){
        var isMobile = Polymer.dom(e.currentTarget).parentNode.classList.contains("mobileTab");
        var isDesktop = e.currentTarget.classList.contains("desktopTab");
        // hypotenuse of 45 degree rotated square that is before the dialog... meaning the width in relative terms
        var beforeWidth = Math.sqrt(Math.pow(20, 2) + Math.pow(20, 2));
        if(isMobile){
          this.$.logoutDialog.positionTarget = e.currentTarget;
          this.$.logoutDialog.verticalAlign = "top";
          this.$.logoutDialog.horizontalAlign = "right";
          this.$.logoutDialog.noOverlap = true;
          this.$.logoutDialog.classList.remove("dialogPointer");
          this.$.logoutDialog.horizontalOffset = -e.currentTarget.offsetLeft -12;
          this.$.logoutDialog.style="width:100%;";
        }
        if(isDesktop){
          this.$.logoutDialog.positionTarget = e.currentTarget;
          this.$.logoutDialog.verticalAlign = "top";
          this.$.logoutDialog.horizontalAlign = "right";
          this.$.logoutDialog.noOverlap = true;
          this.$.logoutDialog.classList.add("dialogPointer");
          this.$.logoutDialog.horizontalOffset = e.currentTarget.offsetWidth / 2 -beforeWidth;
          this.$.logoutDialog.style="";
        };

        this.$.notifyDialog.close();
        this.$.appsDialog.close();
        this.$.logoutDialog.toggle();
      },
      closeLogout:function(){
        this.$.logoutDialog.close();
      },
      _initializeRecentUsers:function(){
        this.$.recentUsers.value=[];
      },
      _computeUserPhoto:function(photo){
        return photo || "/images/defaultAvatar.png"
      },
      _computeDisplayName:function(name){
        if(name === "undefined undefined"){
          return "click here to set display name.";
        } else {
          return name;
        };
      }
    });

  </script>

</dom-module>
