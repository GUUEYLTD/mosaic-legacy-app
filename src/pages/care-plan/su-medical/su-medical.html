<link rel="import" href="dependencies.html" />


<dom-module id="su-medical">

  <template>

    <firebase-storage
      id="pdf"
      app-name="main"
      path="uploads/[[home]]/[[patient]]">
    </firebase-storage>

    <firebase-document
      id="fileLocDB"
      app-name="main">
    </firebase-document>

    <firebase-query
      id="uploadsDB"
      app-name="main"
      path="homes/[[home]]/patients/[[patient]]/uploads"
      data={{uploadsData}}>
    </firebase-query>

    <style include="app-grid-style">
      :host{
        --app-grid-columns:2;
        --app-grid-expandible-item-columns:2;
      }
      paper-card{
        width:80%;
        margin:-50px 10% 50px 10%;
      }
      .pdfContainer{
        margin-bottom:50px;
        border:1px solid black;
      }
      .inputContainer{
        width:100%;
        display:inline-flex;
        flex-direction:row;
      }
      #fileInputDisplay{
        background-color: #009688;
        width:100%;
        color:#FFF;
        margin:0;
      }
      #fileInputName{
        align-self:center;
        margin-top:-15px;
      }
      .grid-container{
        padding:10%;
      }
      #tableInput{
        margin:0;
        padding:0;
        padding-bottom:20px;
        width:90%;
      }
      table{
        width:90%;
        margin-left:5%;
        margin-right:5%;
        margin-bottom:100px;
      }
      td{
        text-align:left;
        padding:10px;
      }
      td a{
        text-decoration:none;
        color:#FFF;
      }
      th{
        text-align:left;
      }
      tr{
        width:100%;
      }
      tr:nth-child(odd){
        background-color:#FFF;
        border-color:#FFF;
      }
      tr:nth-child(even){
        background-color:#EEE;
        border-color:#EEE;
      }
    </style>

      <paper-card elevation="3">
        <su-header
          page="Medical Assessment"
          home="[[home]]"
          patient="[[patient]]">
        </su-header>
        <div class="inputContainer app-grid">
          <div class="grid-container">
            <paper-input id="fileInputName" label="Asessment Name" value="{{newFileName}}"></paper-input>
          </div>

          <div class="grid-container">
            <paper-button
              id="fileInputDisplay"
              on-tap="_onAddFilesClick">upload file
            </paper-button>
          </div>

        </div>

        <input
          type="file"
          id="fileInput"
          on-change="fileChange"
          hidden>
        </input>
        <table>
          <thead>
            <tr>
              <th>
                Document Title
              </th>
              <th>
                Date of Upload
              </th>
              <th>
                Notes
              </th>
              <th>
                Location
              </th>
            </tr>
          </thead>
          <tbody>
            <template is="dom-repeat" items="{{uploadsData}}" as="upload">
              <tr>
                <td>
                  <paper-input id="tableInput" label="file name" value="{{upload.customName}}"></paper-input>
                </td>
                <td>
                  [[upload.dateUploaded]]
                </td>
                <td>
                  <paper-input id="tableInput" label="comments" value="{{upload.comments}}"></paper-input>
                </td>
                <td>
                  <paper-button id="fileInputDisplay" on-tap="openFile">go to file</paper-button>
                </td>
              </tr>
            </template>
          </tbody>
        </table>

      </paper-card>

  </template>

  <script>

    Polymer({

      is: 'su-medical',
      ready:function(){
        this.fire("pageLoaded", {page:this.page});
        this.addEventListener("print", this.print);
      },
      properties:{
        patient:{
          type:String
        },
        home:{
          type:String
        }
      },
      fileChange:function(e) {
        var file = e.target.files[0];
        this.uploadedFile=file;
        this.$.pdf._uploadFile(file)
        .then(function(fileLoc) {
          //save the location to the firebase reg db...
          var path="/homes/"+this.home+"/patients/"+this.patient+"/uploads";
          var date= new Date().toDateString();
            this.$.fileLocDB.data={
            location:fileLoc,
            dateUploaded:date,
            customName:this.newFileName
          };
          this.$.fileLocDB.save(path,null)
            .then(function(snapshot){
              this.newFileName=null;
            }.bind(this));
        }.bind(this))
        .catch(function(error){
          console.log(error);
        });
      },
      _onAddFilesClick: function(e) {
        if (document.createEvent) {
          this.$.fileInput.value = '';
          this.$.fileInput.click();
        }
      },
      openFile:function(e){
        window.open(e.model.upload.location);
      },
      print:function(e){
        var printable=window.open("","printable", "height:=400, width=600");
        printable.document.write("<html><head>");
        printable.document.write("</head><body>");
        printable.document.write("<div style='width:100% padding:5%;'>");
        printable.document.write("<p>Build Print pages later.</p></br>")
        printable.document.write("</body></html>");
        printable.document.write("</div>");
        printable.print();
        printable.close();

      }
    });

  </script>

</dom-module>
