<link rel="import" href="dependencies.html" />


<dom-module id="su-medical">

  <template>

    <firebase-storage
      id="pdf"
      app-name="main"
      path="uploads/[[home]]/[[patient]]">
    </firebase-storage>

    <firebase-document
      id="fileLocDB"
      app-name="main">
    </firebase-document>

    <firebase-query
      id="uploadsDB"
      app-name="main"
      path="homes/[[home]]/patients/[[patient]]/uploads"
      data={{uploadsData}}>
    </firebase-query>

    <iron-media-query
      query="(max-width:900px)"
      query-matches="{{query900}}">
    </iron-media-query>

    <style include="common-styles">
      :host{
        --app-grid-columns:2;
        --app-grid-expandible-item-columns:2;
      }
      .guuey-button{
        width:100%;
        margin:0;
      }
      #fileInputName{
        align-self:center;
        margin-top:-15px;
      }
      #tableInput{
        margin:0;
        padding:0;
        padding-bottom:20px;
        width:90%;
      }

    </style>

      <paper-card class="pageCard" elevation="3">
        <su-header
          page="Medical Assessment"
          home="[[home]]"
          patient="[[patient]]">
        </su-header>
        <div class="app-grid padded">
          <div class="padded">
            <paper-input id="fileInputName" label="Asessment Name" value="{{newFileName}}"></paper-input>
          </div>

          <div class="pageInnerCont padded">
            <paper-button
              class="guuey-button"
              on-tap="_onAddFilesClick">upload file
            </paper-button>
          </div>

        </div>

        <input
          type="file"
          id="fileInput"
          on-change="fileChange"
          hidden>
        </input>
        <div class="guuey-table">
          <p class="tableScrollLabel">
            swipe left scrolls table
          </p>
          <table>
            <thead>
              <tr>
                <th>
                  Document Title
                </th>
                <th>
                  Date of Upload
                </th>
                <th>
                  Notes
                </th>
                <th>
                  Location
                </th>
              </tr>
            </thead>
            <tbody>
              <template is="dom-repeat" items="{{uploadsData}}" as="upload">
                <tr>
                  <td>
                    <paper-input id="tableInput" label="file name" value="{{upload.customName}}"></paper-input>
                  </td>
                  <td>
                    [[upload.dateUploaded]]
                  </td>
                  <td>
                    <paper-input id="tableInput" label="comments" value="{{upload.comments}}"></paper-input>
                  </td>
                  <td>
                    <paper-button class="guuey-button" on-tap="openFile">go to file</paper-button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>


        </div>

      </paper-card>

  </template>

  <script>

    Polymer({

      is: 'su-medical',
      ready:function(){
        this.fire("pageLoaded", {page:this.page});
        this.addEventListener("print", this.print);
      },
      properties:{
        patient:{
          type:String
        },
        home:{
          type:String
        }
      },
      observers:[
        "editQuery(query900)"
      ],
      behaviors:[
        Polymer.carePlanAnimation,
        Polymer.suPrintBehavior
      ],
      fileChange:function(e) {
        var file = e.target.files[0];
        this.uploadedFile=file;
        this.$.pdf._uploadFile(file)
        .then(function(fileLoc) {
          //save the location to the firebase reg db...
          var path="/homes/"+this.home+"/patients/"+this.patient+"/uploads";
          var date= new Date().toDateString();
            this.$.fileLocDB.data={
            location:fileLoc,
            dateUploaded:date,
            customName:this.newFileName
          };
          this.$.fileLocDB.save(path,null)
            .then(function(snapshot){
              this.newFileName=null;
            }.bind(this));
        }.bind(this))
        .catch(function(error){
          console.log(error);
        });
      },
      _onAddFilesClick: function(e) {
        if (document.createEvent) {
          this.$.fileInput.value = '';
          this.$.fileInput.click();
        }
      },
      openFile:function(e){
        window.open(e.model.upload.location);
      },
      editQuery:function(query900){
        if(query900){
          //table style
          this.customStyle["--table-scroll-lable-color"]="inherit";
          this.customStyle["--table-overflow"]="scroll";
          this.customStyle["--tbody-display"]="block";
          this.customStyle["--thead-tr-position"]="relative";
          this.customStyle["--thead-tr-display"]="block";
          this.customStyle["--thead-tr-td-width"]="150px";
          this.customStyle["--td-th-min-width"]="150px";
          this.customStyle["--td-th-last-width"]="150px";
          //fab style
          this.customStyle["--main-fab-position"]="fixed";
          this.customStyle["--main-fab-top"]="unset";
          this.customStyle["--main-fab-bottom"]="5%";

          this.updateStyles();
        } else {
          this.customStyle["--table-scroll-lable-color"]="transparent";
          this.customStyle["--table-overflow"]="unset";
          this.customStyle["--tbody-display"]="table-row-group";
          this.customStyle["--thead-tr-position"]="unset";
          this.customStyle["--thead-tr-display"]="table-row";
          this.customStyle["--thead-tr-td-width"]="unset";
          this.customStyle["--td-th-min-width"]="unset";
          this.customStyle["--td-th-last-width"]="unset";

          this.customStyle["--main-fab-position"]="absolute";
          this.customStyle["--main-fab-top"]="235px";
          this.customStyle["--main-fab-bottom"]="unset";
          this.updateStyles();
        };
      }
    });

  </script>

</dom-module>
