<link rel="import" href="dependencies.html" />
<dom-module id="su-risk">

  <template>

    <!--firebase query to get all of the risk assessments-->
    <firebase-query
      id="risksDB"
      path="/homes/[[home]]/patients/[[patient]]/riskAssessment"
      data="{{risksDataLive}}"
      app-name="main">
    </firebase-query>

    <app-indexeddb-mirror
      key="risksDB|[[patient]]"
      data="{{risksDataLive}}"
      persisted-data="{{risksData}}"
      worker-url="../../../../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror-worker.js">
    </app-indexeddb-mirror>

    <!--db to edit single document that has been selected-->
    <firebase-document
      id="riskDB"
      data="{{riskData}}"
      app-name="main">
    </firebase-document>

    <!--db to print-->
    <firebase-document
      id="printDB"
      path="/homes/[[home]]/patients/[[patient]]/riskAssessment"
      app-name="main">
    </firebase-document>

    <!--media query workaround for shadow dom-->
    <iron-media-query
      query="(max-width:1300px)"
      query-matches="{{query1300}}">
    </iron-media-query>
    <iron-media-query
      query="(max-width:1100px)"
      query-matches="{{query1100}}">
    </iron-media-query>
    <iron-media-query
      query="(max-width:750px)"
      query-matches="{{query750}}">
    </iron-media-query>
    <iron-media-query
      query="(max-width:640px)"
      query-matches="{{query640}}">
    </iron-media-query>

    <style include="app-grid-style">
      :host{
        --app-grid-columns:3;
        --app-grid-item-height:150%;
      }
      .dateInput{
        padding-top:40px;
      }
      .inputWrapper{
        padding:20px;
      }
      .mainCard{
        width:80%;
        margin:-50px 10% 50px 10%;
      }
      .riskDescription{
        text-align:center;
        font-size:18px;
        height:50%;
        max-height:50%;
        margin:4%;
        overflow:hidden;
      }
      .riskBox{
        margin:20px;
        padding: 0 !important;
      }
      .riskHeading{
        width:100%;
        height:40%;
        margin-top:0 !important;
        margin-bottom:4%;
        position:relative;
        background-repeat:no-repeat;
        background-size:cover;
        background-position:bottom right;
      }
      .riskLabel{
        width:25%;
        position:absolute;
        bottom:10px;
        left:10px;
        padding:0px;
        margin:0px;
        font-weight:bold;
        color:#FFFFFF;
        font-size:20px;
      }
      .riskCardText{
        padding:10px;
      }
      .dateContainer{
        padding:10px;
      }

      .mainFab{
        position:absolute;
        right:-25px;
        top:-25px;
        z-index:1;
        position:var(--main-fab-position);
        bottom:var(--main-fab-bottom);
        top:var(--main-fab-top);
        right:var(--main-fab-right);
      }
      .mainContainer{
        padding-top:20px;
        position:relative;
      }
      .guuey-button{
        background-color:#41847d;
        color:#FFFFFF;
        width:60%;
        margin: 4% 20% 4% 20%;
        height:10%;
      }
      .addRiskHeader{
        color:#FFF;
        background-color:#673AB7;
        margin-top:0px !important;
      }
      .addRiskHeader h2{
        padding:15px;
      }
      #addRiskDialog{
        padding:20px;
      }
      .riskMore{
        position:absolute;
        top:10px;
        right:10px;
        color:#FFFFFF;
      }
    </style>

    <paper-dialog horizontal-align="left" vertical-align="top" id="editModal">
      <paper-button on-tap="editRisk">edit</paper-button>
      <br />
      <paper-button on-tap="deleteRisk">delete</paper-button>
    </paper-dialog>

    <paper-dialog id="addRiskDialog">
      <div class="addRiskHeader">
        <h2>Add New Goal</h2>
      </div>

      <vaadin-combo-box
        label="Category"
        items="[[riskTypes]]"
        value="{{riskData.category}}">
      </vaadin-combo-box>

      <guuey-date-input
        value="{{riskData.date}}"
        label="Date of risk assessment">
      </guuey-date-input>

      <paper-textarea
        label="Background of Risk"
        value="{{riskData.backgroundOfRisk}}">
      </paper-textarea>

      <paper-textarea
        label="Risk Identified"
        value="{{riskData.riskIdentified}}">
      </paper-textarea>

      <paper-textarea
        label="Crisis Plan"
        value="{{riskData.crisisPlan}}">
      </paper-textarea>

      <vaadin-combo-box
        label="Agreed Frequencey of Evaluation"
        items="[[evalFreq]]"
        value="{{riskData.agreedFrequencyOfEvaluation}}">
      </vaadin-combo-box>

      <guuey-date-input
        value="{{riskData.evaluation}}"
        label="Date of risk evaluation">
      </guuey-date-input>

      <guuey-slider
        value="{{riskData.riskLevel}}">
      </guuey-slider>
      <paper-button on-tap="cancelNewRisk">cancel</paper-button>
      <paper-button on-tap="saveNewRisk">save</paper-button>

    </paper-dialog>

    <paper-card class="mainCard" elevation="3">
      <su-header
        page="Risk Assessment"
        home="[[home]]"
        patient="[[patient]]">
      </su-header>

      <div class="mainContainer">

        <!--absolute positioned button to add a new risk-->
        <span hidden="[[riskSelected]]">

          <paper-fab
            class="mainFab"
            icon="icons:add"
            on-tap="addRisk"
            hidden="[[riskSelected]]">
          </paper-fab>

        </span>

        <!--absolute positioned button to finsh adding a new risk assessment and close the add view-->
        <span hidden="[[!riskSelected]]">

          <paper-fab
            class="mainFab"
            icon="icons:check"
            on-tap="finishRisk"
            hidden="[[!riskSelected]]">
          </paper-fab>

        </span>

        <div class="app-grid" has-aspect-ratio>

          <!--
          <div hidden="{{queryCount}}">

          </div>
          -->

          <template is="dom-repeat" items="{{risksData}}" as="risk">
            {{_computeQueryCount(risk)}}

            <div class="riskContainer" hidden="[[riskSelected]]">

              <paper-card elevation="3" class="riskBox">

                <div style="background-image:url(../../../../{{_computeRiskImage(risk.category)}})" class="riskHeading">
                  <p class="riskLabel">
                    [[risk.category]]
                  </p>
                </div>

                <guuey-slider value="{{risk.riskLevel}}">
                </guuey-slider>

                <p class="riskCardText">
                  [[risk.riskIdentified]]
                </p>

                <div style="border-bottom:1px solid grey; width:100%;" class="divider">

                </div>
                <div class="dateContainer">
                  <p class="dateHeader">
                    Date of Assessment
                  </p>
                  <iron-icon icon="editor:insert-invitation"></iron-icon>{{_computeDate(risk.date)}}
                  <br />
                  <iron-icon icon="icons:update"></iron-icon>{{_computeDate(risk.evaluation)}}
                </div>
                <paper-icon-button
                  icon="icons:more-vert"
                  class="riskMore"
                  on-tap="toggleEditModal">
                </paper-icon-button>


              </paper-card>

            </div>

          </template>

        </div>

        <div class="inputWrapper" hidden="[[!riskSelected]]">

          <vaadin-combo-box
            label="Category"
            items="[[riskTypes]]"
            value="{{riskData.category}}">
          </vaadin-combo-box>

          <guuey-date-input
            value="{{riskData.date}}"
            label="Date of risk assessment">
          </guuey-date-input>

          <guuey-text-input
            value="{{riskData.backgroundOfRisk}}"
            label="Background of Risk">
          </guuey-text-input>

          <guuey-text-input
            value="{{riskData.riskIdentified}}"
            label="Risk Identified">
          </guuey-text-input>

          <guuey-text-input
            value="{{riskData.crisisPlan}}"
            label="crisis Plan"
            label2="How to Address">
          </guuey-text-input>

          <vaadin-combo-box
            label="Agreed Frequencey of Evaluation"
            items="[[evalFreq]]"
            value="{{riskData.agreedFrequencyOfEvaluation}}">
          </vaadin-combo-box>

          <guuey-date-input
            value="{{riskData.evaluation}}"
            label="Date of risk evaluation">
          </guuey-date-input>

          <guuey-slider
            value="{{riskData.riskLevel}}">
          </guuey-slider>

        </div>

      </div>

    </paper-card>

  </template>

  <script>

    Polymer({

      is: 'su-risk',
      ready:function(){
        this.fire("pageLoaded", {page:this.page});
        this.addEventListener("print", this.print);
      },
      properties:{
        page:{
          type:String,
        },
        patient:{
          type:String,
        },
        home:{
          type:String,
        },
        inputDisabled:{
          type:Boolean,
          value:true
        },
        riskSelected:{
          type:Boolean,
          value:false
        },
        evalFreq:{
          type:Array,
          value:[
            "daily",
            "weekly",
            "bi-weekly",
            "monthly",
            "bi-monthly",
            "yearly"
          ]
        },
        riskTypes:{
          type:Array,
          value:[
            "Moving & Handling",
            "Slips & Trips",
            "Violence & Agression",
            "Falls From Windows & Balconies",
            "Scalding & Burning",
            "Bedrail Entrapment",
            "Legionella",
            "Other"
          ]
        }
      },
      observers:[
        "editQuery(query1300, query1100, query750, query640)",
        "requirementsMet(risksData)"
      ],
      toggleEditModal:function(e){
        this.$.editModal.positionTarget = e.target;
        this.riskUID=e.model.risk.$key;
        this.$.editModal.toggle();
      },
      //is this useless???? i think so... test later
      editField:function(event){
        event.model.set('item.name','stuff');
      },
      toggleEdit:function(){
        this.inputDisabled=!this.inputDisabled;
      },
      addRisk:function(){
        this.$.riskDB.path=null;
        this.$.riskDB.data={};
        this.$.addRiskDialog.open();
      },
      saveNewRisk:function(){
        var path="/homes/"+this.home+"/patients/"+this.patient+"/riskAssessment";
        this.$.riskDB.save(path, null)
          .then(function(val){
            this.$.addRiskDialog.close();
            this.fire("openToast",{toastText:"New risk assessment saved."});
          }.bind(this))
          .catch(function(error){
            this.$.addRiskDialog.close();
            this.fire("openToast",{toastText:"There was an error saving the new risk: "+error});
          }.bind(this));
      },
      cancelNewRisk:function(){
        this.$.addRiskDialog.close();
        this.$.riskDB.data={};
      },
      editRisk:function(e){
        this.riskSelected=true;
        this.$.riskDB.path="/homes/"+this.home+"/patients/"+this.patient+"/riskAssessment/"+this.riskUID;
        this.$.editModal.close();
      },
      deleteRisk:function(e){
        var path="/homes/"+this.home+"/patients/"+this.patient+"/riskAssessment/"+this.riskUID;
        this.$.riskDB.setStoredValue(path, null);
        this.$.editModal.close();
      },
      finishRisk:function(e){
        this.riskSelected=false;
      },
      _computeDate:function(date){
        if(typeof date==="string"){
          return date.slice(3,15);
        } else {
          return "Date not set";
        };
      },
      _computeRiskImage:function(cat){

        switch(cat) {
          case "Moving & Handling":
              return "images/risks/movingHandling.png";
              break;
          case "Slips & Trips":
              return "images/risks/slipsTrips.png";
              break;
          case "Violence & Agression":
              return "images/risks/violenceAgression.png";
              break;
          case "Falls From Windows & Balconies":
              return "images/risks/falls.png";
              break;
          case "Scalding & Burning":
              return "images/risks/scaldingBurning.png";
              break;
          case "Bedrail Entrapment":
              return "images/risks/bedrailEntrapment.png";
              break;
          case "Legionella":
              return "images/risks/legionella.png";
              break;
          default:
              return "images/risks/other.png";
              break;
        };
      },
      _computeQueryCount:function(goal){
        if(!this.queryCount){
          this.queryCount=0;
        };
        this.queryCount++;
      },
      print:function(e){
        var printable=window.open("","printable");
        printable.document.write("<html><head>");
        printable.document.write("</head><body>");
        printable.document.write("<div style='width:100% padding:5%;'>");
        var printData=this.$.printDB.data;
        for(x in printData){
          var assmt=printData[x];
          printable.document.write("<p style='font-weight:bold;'>"+assmt.date.slice(0,15)+"</p>");
          for(y in assmt){
            var subAssmt=assmt[y];
            if(y!="date"){
              printable.document.write("<p>"+this.convertToPrintText(y)+": "+subAssmt.info+"</p>");
            };
          };
        };
        printable.document.write("</body></html>");
        printable.document.write("</div>");
        printable.print();
        printable.close();

      },
      convertToPrintText:function(camelCase){
        if (camelCase == null || camelCase == "") {
          return camelCase;
        }

        camelCase = camelCase.trim();
        var newText = "";
        for (var i = 0; i < camelCase.length; i++) {
          if (/[A-Z]/.test(camelCase[i])
              && i != 0
              && /[a-z]/.test(camelCase[i-1])) {
            newText += " ";
          }
          if (i == 0 && /[a-z]/.test(camelCase[i]))
          {
            newText += camelCase[i].toUpperCase();
          } else {
            newText += camelCase[i];
          }
        }
        return newText;
      },
      requirementsMet:function(data){
        //change case
        this.$.risksDB.query.on("child_changed",function(){
          var riskData = this.$.riskDB.data;
          if(!riskData.date){
            this.fire("openToast", {toastText:"Date of risk assessment is reqiured."});
          };
        }.bind(this));
      },
      editQuery:function(query1300, query1100, query750, query640){
        if(query640){
          //column style
          this.customStyle["--app-grid-columns"]="1";

          //fab style
          this.customStyle["--main-fab-position"]="fixed";
          this.customStyle["--main-fab-top"]="unset";
          this.customStyle["--main-fab-bottom"]="5%";
          this.customStyle["--main-fab-right"]="5%";
          this.updateStyles();
        } else if(query750){
          //column style
          this.customStyle["--app-grid-columns"]="1";

          //fab style
          this.customStyle["--main-fab-position"]="absolute";
          this.customStyle["--main-fab-top"]="-25px";
          this.customStyle["--main-fab-right"]="-25px";
          this.customStyle["--main-fab-bottom"]="unset";
          this.updateStyles();
        } else if(query1100){
          //column style
          this.customStyle["--app-grid-columns"]="2";

          //fab style
          this.customStyle["--main-fab-position"]="absolute";
          this.customStyle["--main-fab-top"]="-25px";
          this.customStyle["--main-fab-right"]="-25px";
          this.customStyle["--main-fab-bottom"]="unset";
          this.updateStyles();
        } else if(query1300){
          //column style
          this.customStyle["--app-grid-columns"]="2";

          //fab style
          this.customStyle["--main-fab-position"]="absolute";
          this.customStyle["--main-fab-top"]="-25px";
          this.customStyle["--main-fab-right"]="-25px";
          this.customStyle["--main-fab-bottom"]="unset";
          this.updateStyles();
        }  else {
          //column style
          this.customStyle["--app-grid-columns"]="3";

          //fab style
          this.customStyle["--main-fab-position"]="absolute";
          this.customStyle["--main-fab-top"]="-25px";
          this.customStyle["--main-fab-right"]="-25px";
          this.customStyle["--main-fab-bottom"]="unset";
          this.updateStyles();
        };
      },
    });

  </script>

</dom-module>
