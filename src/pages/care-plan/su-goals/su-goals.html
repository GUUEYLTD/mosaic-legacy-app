<link rel="import" href="dependencies.html" />
<link rel="import" href="su-goals-edit-view.html" />
<link rel="import" href="su-goals-multi-view.html" />
<dom-module id="su-goals">

  <template>

    <!-- db query to find all goals for a patient-->
    <firebase-query
      id="goalsDB"
      app-name="main"
      path="homes/[[home]]/patients/[[patient]]/personalGoals"
      data="{{goalsDataLive}}">
    </firebase-query>

    <app-indexeddb-mirror
      key="goalsDB|[[patient]]"
      data="{{goalsDataLive}}"
      persisted-data="{{goalsData}}"
      worker-url="../../../../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror-worker.js">
    </app-indexeddb-mirror>

    <!--db to create new goal for a patient-->
    <firebase-document
      id="goalDB"
      app-name="main"
      data="{{goalData}}">
    </firebase-document>

    <firebase-query
      id="stepsDB"
      app-name="main"
      data="{{stepsDataLive}}">
    </firebase-query>

    <app-indexeddb-mirror
      key="stepsDB|[[patient]]"
      data="{{stepsDataLive}}"
      persisted-data="{{stepsData}}"
      worker-url="../../../../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror-worker.js">
    </app-indexeddb-mirror>

    <firebase-document
      id="stepDB"
      app-name="main"
      data="{{stepData}}">
    </firebase-document>

    <firebase-query
      id="usersDB"
      app-name="main"
      path="homes/[[home]]/users"
      data="{{usersData}}">
    </firebase-query>

    <!--print db-->
    <firebase-document
      id="printDB"
      app-name="main"
      path="homes/[[home]]/patients/[[patient]]/personalGoals">
    </firebase-document>

    <!--media query workaround for shadow dom-->
    <iron-media-query
      query="(max-width:1200px)"
      query-matches="{{query1200}}">
    </iron-media-query>
    <iron-media-query
      query="(max-width:850px)"
      query-matches="{{query850}}">
    </iron-media-query>
    <iron-media-query
      query="(max-width:950px)"
      query-matches="{{query950}}">
    </iron-media-query>
    <iron-media-query
      query="(max-width:640px)"
      query-matches="{{query640}}">
    </iron-media-query>

    <style include="common-styles">
      :host{

      }
    </style>

    <guuey-new-goal-modal
      id="addGoalModal"
      value="{{newGoal}}"
      users="[[userList]]">
    </guuey-new-goal-modal>

    <paper-card class="pageCard" elevation="3">

      <su-header
        id="suHeader"
        page="Personal Goals"
        patient="[[patient]]"
        home="[[home]]"
        su-index-data={{suBasicInfo}}>
      </su-header>

      <!--repeat each goal that currently is set-->
      <div class="pageInnerCont">

          <!--absolute positioned button to finsh adding a new goal and close the add view-->
          <paper-fab
            id="editFab"
            icon="icons:check"
            on-tap="finishGoal">
          </paper-fab>

          <!--absolute positioned button to add a new goal-->
          <paper-fab
            id="regFab"
            icon="icons:add"
            on-tap="addGoal">
          </paper-fab>

          <!--default placeholder if user has not put any goals in yet...-->
          <!--
          <div hidden="{{queryCount}}">


          </div>
          -->
          <neon-animated-pages
            attr-for-selected="name"
            selected="[[pageState]]">

            <su-goals-multi-view
              name="multi-view"
              goals-data="{{goalsData}}"
              goal-id="{{goalId}}">
            </su-goals-multi-view>

            <su-goals-edit-view
              name="edit-view"
              goal-data="{{goalData}}"
              user-list="[[userList]]"
              step-id="{{stepId}}"
              step-modal-open="{{stepModalOpen}}"
              steps-data="{{stepsData}}"
              step-data="{{stepData}}">
            </su-goals-edit-view>

          </neon-animated-pages>


      </div>

    </paper-card>

  </template>

  <script>

    Polymer({

      is: 'su-goals',
      goEdit:function(){
        this.pageState="edit-view";
      },
      goMulti:function(){
        this.pageState="multi-view";
      },
      ready:function(){
        this.fire("pageLoaded", {page:this.page});
        //print listener
        this.addEventListener("print", this.print);

        //multi-view page listeners
        this.addEventListener("editGoal", this.editGoal);
        this.addEventListener("deleteGoal", this.deleteGoal);

        //edit-view page listeners
        this.addEventListener("addStep", this.addStep);
        this.addEventListener("editStep", this.editStep);
        this.addEventListener("saveStep", this.saveStep);
        this.addEventListener("deleteStep", this.deleteStep);
        this.addEventListener("checkboxChanged", this.checkboxChanged);

        this.$.usersDB.query.on("value", function(snapshot){
          this.updateUsers(snapshot);
        }.bind(this));
      },
      properties:{
        page:{
          type:String
        },
        patient:{
          type:String
        },
        home:{
          type:String
        },
        goalSelected:{
          type:Boolean,
          value:false
        },
        pageState:{
          type:String,
          value:"multi-view"
        },
        goalId:{
          type:String
        },
        stepId:{
          type:String
        },
        stepModalOpen:{
          type:String,
          value:"close"
        },
        goalTypes:{
          type:Array,
          value:[
            "Accommodation",
            "Finance And Budget",
            "Social Skills",
            "Medical Treatment",
            "Mental Health",
            "Other"
          ]
        },
        userList:{
          type:Array,
        },
        newGoal:{
          type:Object,
          value:null,
          observer:"newGoalChanged"
        }
      },
      observers:[
        "editQuery(query1200, query850, query950, query640)",
        "requirementsMet(goalsData)"
      ],
      behaviors:[
        Polymer.fabAnimationBehavior,
        Polymer.carePlanAnimation
      ],
      //activated from child events
      //multi-view event functions
      editGoal:function(e){
         this.$.goalDB.path="homes/"+this.home+"/patients/"+this.patient+"/personalGoals/"+this.goalId;
         this.$.stepsDB.path="homes/"+this.home+"/patients/"+this.patient+"/personalGoals/"+this.goalId+"/steps";
         this.animateEditViewFab();
         this.pageState="edit-view"
      },
      deleteGoal:function(e){
        var path="homes/"+this.home+"/patients/"+this.patient+"/personalGoals/"+this.goalId;
        this.$.goalDB.setStoredValue(path, null);
        this.stepModalOpen="close";
      },
      //edit-view functions
      addStep:function(){
        this.$.stepDB.path=null;
        this.$.stepDB.data={};
        var path="homes/"+this.home+"/patients/"+this.patient+"/personalGoals/"+this.goalId+"/steps";
        this.$.stepDB.save(path, null)
          .then(function(){
            this.stepId=this.$.stepDB.path.slice(path.length+2);
            this.stepModalOpen="open";
            //reset the db path and save the path for later
            this.$.stepDB.path=null;
          }.bind(this));
      },
      editStep:function(){
        this.$.stepDB.path="homes/"+this.home+"/patients/"+this.patient+"/personalGoals/"+this.goalId+"/steps/"+this.stepId;
        this.stepModalOpen="open";
      },
      saveStep:function(){
        var path="homes/"+this.home+"/patients/"+this.patient+"/personalGoals/"+this.goalId+"/steps";
        this.$.stepDB.save(path, this.stepId)
          .then(function(){
            this.fire("openToast",{toastText:"new step saved."});
            this.stepModalOpen="close";
            this.$.stepDB.path=null;
            this.$.stepDB.data={};
          }.bind(this))
          .catch(function(error){
            this.fire("openToast",{toastText:"there was an error saving your new step: "+error});
            this.stepModalOpen="close";
            this.$.stepDB.path=null;
            this.$.stepDB.data={};
          });
      },
      //reg functions
      updateUsers:function(snapshot){
        var tempList=[];
        if(snapshot.val()){
          var data=snapshot.val();
          for(x in data){
            if(data[x].displayName){
              tempList.push(data[x].displayName);
            } else {
              tempList.push(data[x].email);
            };
          };
        };
        this.userList=tempList;
      },
      addGoal:function(){
        this.$.addGoalModal.open();
      },
      newGoalChanged:function(data){
        if(data!=null){
          var path="homes/"+this.home+"/patients/"+this.patient+"/personalGoals/"
          this.$.goalDB.data=data;
          this.$.goalDB.save(path, null)
            .then(function(){
              this.fire("openToast",{toastText:"new goal saved."});
              this.$.goalDB.path=null;
              this.$.goalDB.data={};
            }.bind(this))
            .catch(function(error){
              this.fire("openToast",{toastText:"there was an error saving your new goal: "+error});
              this.$.goalDB.path=null;
              this.$.goalDB.data={};
            });
        }
      },
      finishGoal:function(e){
        this.animateMultiViewFab();
        this.pageState="multi-view"
      },

      print:function(e){
        var printData=this.$.printDB.data;
        var printable=window.open("","printable");
        printable.document.write("<html><head>");
        printable.document.write("</head><body>");
        printable.document.write("<div style='width:100% padding:5%;'>");
        for(x in printData){
          var goal=printData[x];
          printable.document.write("<p style='font-weight:bold;'>Goal</p>");
          for(y in goal){
            var goalProp=goal[y];
            if(y!="steps"){
              printable.document.write("<p>"+y+": "+goalProp+"</p>");
            };
            if(y==="steps"){
              for(z in goalProp){
                var steps=goalProp[z];
                printable.document.write("<p style='font-weight:bold;'>Goal Step</p>");
                for(xx in steps){
                  var stepProp=steps[xx];
                  printable.document.write("<p>"+this.convertToPrintText(xx)+": "+stepProp+"</p>");
                };
              };
            };
          };
        };
        printable.document.write("</body></html>");
        printable.document.write("</div>");
        printable.print();
        printable.close();

      },
      convertToPrintText:function(camelCase){
        if (camelCase == null || camelCase == "") {
          return camelCase;
        }

        camelCase = camelCase.trim();
        var newText = "";
        for (var i = 0; i < camelCase.length; i++) {
          if (/[A-Z]/.test(camelCase[i])
              && i != 0
              && /[a-z]/.test(camelCase[i-1])) {
            newText += " ";
          }
          if (i == 0 && /[a-z]/.test(camelCase[i]))
          {
            newText += camelCase[i].toUpperCase();
          } else {
            newText += camelCase[i];
          }
        }
        return newText;
      },
      checkboxChanged:function(e){
        var stepID=e.detail.stepID;
        var checkBool=e.detail.checkBool;
        var path="homes/"+this.home+"/patients/"+this.patient+"/personalGoals/"+this.goalId+"/steps/"+stepID+"/completed";
        this.$.stepDB.setStoredValue(path, checkBool);
      },
      requirementsMet:function(data){
        //change case
        this.$.goalsDB.query.on("child_changed",function(){
          var goalData=this.$.goalDB.data;
          if(!goalData.category){
            this.fire("openToast", {toastText:"Goal category is required."});
            return false;
          } else if(!goalData.startDate){
            this.fire("openToast", {toastText:"Goal start date is required."});
            return false;
          } else if(!goalData.finishDate){
            this.fire("openToast", {toastText:"Goal finish date is required."});
            return false;
          } else if(!goalData.coordinator){
            this.fire("openToast", {toastText:"Goal cooridnator is required."});
            return false;
          } else if(!goalData.description){
            this.fire("openToast", {toastText:"Goal description is required."});
            return false;
          } else if(!goalData.steps){
            this.fire("openToast", {toastText:"Add steps to the goal."});
          } else {
            return true;
          };
        }.bind(this));
      },
      editQuery:function(query1200, query850, query950, query640){
        if(query640){
          //column style
          this.customStyle["--app-grid-columns"]="1";

          //fab style
          this.customStyle["--main-fab-position"]="fixed";
          this.customStyle["--main-fab-top"]="unset";
          this.customStyle["--main-fab-bottom"]="5%";
          this.customStyle["--main-fab-right"]="5%";

          //table style
          this.customStyle["--table-scroll-lable-color"]="inherit";
          this.customStyle["--table-overflow"]="scroll";
          this.customStyle["--tbody-display"]="block";
          this.customStyle["--thead-tr-position"]="relative";
          this.customStyle["--thead-tr-display"]="block";
          this.customStyle["--thead-tr-td-width"]="150px";
          this.customStyle["--td-th-min-width"]="150px";
          this.customStyle["--td-th-last-width"]="150px";

          //description and detail bar padding
          this.customStyle["--detail-bar-padding"]="0% 10% 20px 40%";
          this.customStyle["--description-container-padding"]="0% 10% 20px 40%";

          this.updateStyles();
        } else if(query850){
          //column style
          this.customStyle["--app-grid-columns"]="1";

          //fab style
          this.customStyle["--main-fab-position"]="absolute";
          this.customStyle["--main-fab-top"]="-25px";
          this.customStyle["--main-fab-right"]="-25px";
          this.customStyle["--main-fab-bottom"]="unset";

          //table style
          this.customStyle["--table-scroll-lable-color"]="inherit";
          this.customStyle["--table-overflow"]="scroll";
          this.customStyle["--tbody-display"]="block";
          this.customStyle["--thead-tr-position"]="relative";
          this.customStyle["--thead-tr-display"]="block";
          this.customStyle["--thead-tr-td-width"]="150px";
          this.customStyle["--td-th-min-width"]="150px";
          this.customStyle["--td-th-last-width"]="150px";

          //description and detail bar padding
          this.customStyle["--detail-bar-padding"]="0% 10% 20px 40%";
          this.customStyle["--description-container-padding"]="0% 10% 20px 40%";

          this.updateStyles();
        } else if(query950){
          //column style
          this.customStyle["--app-grid-columns"]="1";

          //fab style
          this.customStyle["--main-fab-position"]="absolute";
          this.customStyle["--main-fab-top"]="-25px";
          this.customStyle["--main-fab-right"]="-25px";
          this.customStyle["--main-fab-bottom"]="unset";

          //table style
          this.customStyle["--table-scroll-lable-color"]="inherit";
          this.customStyle["--table-overflow"]="scroll";
          this.customStyle["--tbody-display"]="block";
          this.customStyle["--thead-tr-position"]="relative";
          this.customStyle["--thead-tr-display"]="block";
          this.customStyle["--thead-tr-td-width"]="150px";
          this.customStyle["--td-th-min-width"]="150px";
          this.customStyle["--td-th-last-width"]="150px";

          //description and detail bar padding
          this.customStyle["--detail-bar-padding"]="0% 25% 20px 25%";
          this.customStyle["--description-container-padding"]="0% 25% 20px 25%";

          this.updateStyles();
        } else if(query1200){
          //column style
          this.customStyle["--app-grid-columns"]="2";

          //fab style
          this.customStyle["--main-fab-position"]="absolute";
          this.customStyle["--main-fab-top"]="-25px";
          this.customStyle["--main-fab-right"]="-25px";
          this.customStyle["--main-fab-bottom"]="unset";

          //table style
          this.customStyle["--table-scroll-lable-color"]="transparent";
          this.customStyle["--table-overflow"]="unset";
          this.customStyle["--tbody-display"]="table-row-group";
          this.customStyle["--thead-tr-position"]="unset";
          this.customStyle["--thead-tr-display"]="table-row";
          this.customStyle["--thead-tr-td-width"]="unset";
          this.customStyle["--td-th-min-width"]="unset";
          this.customStyle["--td-th-last-width"]="unset";

          //description and detail bar padding
          this.customStyle["--detail-bar-padding"]="0% 25% 20px 25%";
          this.customStyle["--description-container-padding"]="0% 25% 20px 25%";

          this.updateStyles();
        } else {
          //column style
          this.customStyle["--app-grid-columns"]="3";

          //fab style
          this.customStyle["--main-fab-position"]="absolute";
          this.customStyle["--main-fab-top"]="-25px";
          this.customStyle["--main-fab-right"]="-25px";
          this.customStyle["--main-fab-bottom"]="unset";

          //table style
          this.customStyle["--table-scroll-lable-color"]="transparent";
          this.customStyle["--table-overflow"]="unset";
          this.customStyle["--tbody-display"]="table-row-group";
          this.customStyle["--thead-tr-position"]="unset";
          this.customStyle["--thead-tr-display"]="table-row";
          this.customStyle["--thead-tr-td-width"]="unset";
          this.customStyle["--td-th-min-width"]="unset";
          this.customStyle["--td-th-last-width"]="unset";

          //description and detail bar padding
          this.customStyle["--detail-bar-padding"]="0% 25% 20px 25%";
          this.customStyle["--description-container-padding"]="0% 25% 20px 25%";

          this.updateStyles();


        };
      }
    });

  </script>

</dom-module>
