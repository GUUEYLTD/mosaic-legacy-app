<link rel="import" href="dependencies.html" />

<dom-module id="su-medication">

  <template>
    <firebase-document
      id="medDB"
      app-name="main">
    </firebase-document>

    <firebase-document
      id="timeDB"
      app-name="main">
    </firebase-document>

    <firebase-document
      id="timesDB"
      app-name="main"
      path="homes/[[home]]/patients/[[patient]]/medicationOutline/timeChunks"
      data="{{timesData}}">
    </firebase-document>

    <firebase-document
      id="medsDB"
      path="homes/[[home]]/patients/[[patient]]/medicationOutline/medications"
      data="{{medsDataLive}}"
      app-name="main">
    </firebase-document>

    <app-indexeddb-mirror
      key="medsDB|[[patient]]"
      data="{{medsDataLive}}"
      persisted-data="{{medsData}}"
      worker-url="../../../../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror-worker.js">
    </app-indexeddb-mirror>

    <iron-media-query
      query="(max-width:1000px)"
      query-matches="{{query1000}}">
    </iron-media-query>

    <iron-media-query
      query="(max-width:640px)"
      query-matches="{{query640}}">
    </iron-media-query>

    <style include="paper-time-picker-dialog-style"></style>
    <style include="common-styles">
      :host{
        --app-grid-columns:2;
        --app-grid-expandible-item-columns:2;
      }
      .timeChunkMorning{
          background-image:url(../../../../images/timechunks/morning.png);
      }
      .timeChunkAfternoon{
          background-image:url(../../../../images/timechunks/afternoon.png);
      }
      .timeChunkEvening{
          background-image:url(../../../../images/timechunks/evening.png);
      }
      .timeChunkNight{
          background-image:url(../../../../images/timechunks/night.png);
      }
      .timeChunkBar{
        background-color:#F5F2F2;
        margin:20px 0 20px 0;
        padding:30px;
        background-repeat:no-repeat;
        background-size:40px 40px;
        background-position:20px;
        text-align:center;
        display:flex;
        flex-direction:row;
      }
      .timeChunkLabel{
        flex-grow:1;
        text-transform:uppercase;
        color:#009688;
      }
      .timeChunkLabel:hover{
        cursor:pointer;
      }
      .timeChunkTime{
        font-weight:bold;
        font-size:20px;
        text-transform:uppercase;
        opacity:.54;
      }
      .timeSection{
        text-align:center;
      }
      .timeSection *{
        width:50%;
      }
      #timeChunkModal{
        margin:0;
      }
      #timeChunkModal paper-item{
        text-transform:uppercase;
      }
      #timeChunkModal paper-item:hover{
        cursor:pointer;
      }
      .commentButton{
        color:#009688;
      }
    </style>

    <paper-dialog
      id="timeChunkModal"
      horizontal-align="right"
      vertical-align="top"
      no-overlap>

      <paper-item on-tap="editTimeDialog">edit time</paper-item>
      <paper-item on-tap="toggleNotifications">turn on notifications</paper-item>

    </paper-dialog>

    <paper-dialog id="medModal" class="guuey-modal guuey-add-modal">

        <h2>Add Medication</h2>

        <paper-input
          label="Medication Name"
          value="{{newMed.medicine}}"
          required
          auto-validate
          pattern="[a-zA-Z\s]*"
          error-message="Please enter a valid medicine name.">
        </paper-input>

        <vaadin-combo-box
          class="dialogHalf"
          allow-custom-status
          label="Method"
          value="{{newMed.method}}"
          items="[[medMethods]]"
          required
          auto-validate
          error-message="Please select a method.">
        </vaadin-combo-box>
        <!--need units of meds-->
        <paper-input
          class="dialogHalf"
          label="dosage"
          value="{{newMed.dosage}}"
          required
          auto-validate
          pattern="\d{1,4}[a-zA-Z\s]*"
          error-message="Please enter in the following format: (number) (units).">
        </paper-input>

        <paper-textarea
          label="Comments"
          value="{{newMed.comment}}">
        </paper-textarea>

        <guuey-time-chunk-selector
          value="{{newMed.timeChunk}}">
        </guuey-time-chunk-selector>

        <guuey-weekday-selector
          value="{{newMed.weekdays}}">
        </guuey-weekday-selector>

        <div class="modal-button-container">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button on-tap="saveMed">Save</paper-button>
        </div>

    </paper-dialog>

    <paper-dialog id="editMedModal" class="guuey-modal guuey-view-modal">

      <h2>Edit/View Medication</h2>

      <paper-input
        label="Medication Name"
        value="{{newMedEdit.medicine}}"
        required
        auto-validate
        pattern="[a-zA-Z\s]*"
        error-message="Please enter a valid medicine name.">
      </paper-input>

      <vaadin-combo-box
        class="dialogHalf"
        allow-custom-status
        label="Method"
        value="{{newMedEdit.method}}"
        items="[[medMethods]]"
        required
        auto-validate
        error-message="Please select a method.">
      </vaadin-combo-box>
      <!--need units of meds-->
      <paper-input
        class="dialogHalf"
        label="dosage"
        value="{{newMedEdit.dosage}}"
        required
        auto-validate
        pattern="\d{1,4}[a-zA-Z\s]*"
        error-message="Please enter in the following format: (number) (units).">
      </paper-input>

      <paper-textarea
        label="Comments"
        value="{{newMedEdit.comment}}">
      </paper-textarea>

      <guuey-time-chunk-selector
        value="{{newMedEdit.timeChunk}}">
      </guuey-time-chunk-selector>

      <guuey-weekday-selector
        value="{{newMedEdit.weekdays}}">
      </guuey-weekday-selector>

      <div class="modal-button-container">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button on-tap="saveEditMed">Save</paper-button>
      </div>

    </paper-dialog>

    <paper-dialog id="editTimeDialog" class="paper-time-picker-dialog">

      <paper-time-picker
        id="editTimePicker"
        time="{{newTime}}">
      </paper-time-picker>

      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button on-tap="saveEditTime">Save Changes</paper-button>
      </div>

    </paper-dialog>

    <paper-card class="pageCard">
      <su-header
      page="Medication Outline"
      home="[[home]]"
      patient="[[patient]]">
      </su-header>

      <div class="pageInnerCont">

        <paper-fab
          id="mainFab"
          icon="add"
          on-tap="startNewMed">
        </paper-fab>

        <paper-item class="timeChunkBar timeChunkMorning">
          <P class="timeChunkLabel" on-tap="toggleMorning">
            morning
          </P>
          <p class="timeChunkTime">
            {{_computeTime(timesData, 'morning')}}
          </p>
          <paper-icon-button
            class="timeChunkButton"
            icon="icons:more-vert"
            time-chunk="morning"
            on-tap="timeChunkOptions">
          </paper-icon-button>
        </paper-item>
        <iron-collapse id="morning" opened>
          <div class="guuey-table">

            <p class="tableScrollLabel">
              swipe left scrolls table
            </p>

            <table>
              <thead>
                <tr>
                  <th>
                    Medication
                  </th>
                  <th>
                    Method
                  </th>
                  <th>
                    Dosage
                  </th>
                  <th>
                    Comment
                  </th>
                  <th>
                    Edit
                  </th>
                </tr>
              </thead>
              <tbody>
                <template
                  is="dom-repeat"
                  items="{{_computeMedList(medsData)}}"
                  as="med"
                  filter="filterMorning"
                  observe="timeChunk">
                  <tr>
                    <td>
                      [[med.medicine]]
                    </td>
                    <td>
                      [[med.method]]
                    </td>
                    <td>
                      [[med.dosage]]
                    </td>
                    <td>
                      <span hidden="[[!med.comment]]">
                        <paper-icon-button
                          class="commentButton"
                          icon="communication:comment"
                          on-tap="editMed">
                        </paper-icon-button>
                      </span>
                    </td>
                    <td>
                      <paper-icon-button on-tap="editMed" icon="editor:editor:mode-edit"></paper-icon-button>
                    </td>
                  </tr>

                </template>
              </tbody>
            </table>

          </div>

        </iron-collapse>

        <paper-item class="timeChunkBar timeChunkAfternoon">
          <P class="timeChunkLabel" on-tap="toggleAfternoon">
            afternoon
          </P>
          <p class="timeChunkTime">
            {{_computeTime(timesData, 'afternoon')}}
          </p>
          <paper-icon-button
            class="timeChunkButton"
            icon="icons:more-vert"
            time-chunk="afternoon"
            on-tap="timeChunkOptions">
          </paper-icon-button>
        </paper-item>
        <iron-collapse id="afternoon">

          <div class="guuey-table">

            <p class="tableScrollLabel">
              swipe left scrolls table
            </p>

            <table>
              <thead>
                <tr>
                  <th>
                    Medication
                  </th>
                  <th>
                    Route
                  </th>
                  <th>
                    Dosage
                  </th>
                  <th>
                    Comment
                  </th>
                  <th>
                    Edit
                  </th>
                </tr>
              </thead>
              <tbody>
                <template
                  is="dom-repeat"
                  items="{{_computeMedList(medsData)}}"
                  as="med"
                  filter="filterAfternoon"
                  observe="timeChunk">
                  <tr>
                    <td>
                      [[med.medicine]]
                    </td>
                    <td>
                      [[med.method]]
                    </td>
                    <td>
                      [[med.dosage]]
                    </td>
                    <td>
                      <span hidden="[[!med.comment]]">
                        <paper-icon-button
                          class="commentButton"
                          icon="communication:comment"
                          on-tap="editMed">
                        </paper-icon-button>
                      </span>
                    </td>
                    <td>
                      <paper-icon-button on-tap="editMed" icon="editor:editor:mode-edit"></paper-icon-button>
                    </td>
                  </tr>

                </template>
              </tbody>
            </table>

          </div>

        </iron-collapse>

        <paper-item class="timeChunkBar timeChunkEvening">
          <P class="timeChunkLabel" on-tap="toggleEvening">
            evening
          </P>
          <p class="timeChunkTime">
            {{_computeTime(timesData, 'evening')}}
          </p>
          <paper-icon-button
            class="timeChunkButton"
            icon="icons:more-vert"
            time-chunk="evening"
            on-tap="timeChunkOptions">
          </paper-icon-button>
        </paper-item>
        <iron-collapse id="evening">

          <div class="guuey-table">

            <p class="tableScrollLabel">
              swipe left scrolls table
            </p>

            <table>
              <thead>
                <tr>
                  <th>
                    Medication
                  </th>
                  <th>
                    Route
                  </th>
                  <th>
                    Dosage
                  </th>
                  <th>
                    Comment
                  </th>
                  <th>
                    Edit
                  </th>
                </tr>
              </thead>
              <tbody>
                <template
                  is="dom-repeat"
                  items="{{_computeMedList(medsData)}}"
                  as="med"
                  filter="filterEvening"
                  observe="timeChunk">
                  <tr>
                    <td>
                      [[med.medicine]]
                    </td>
                    <td>
                      [[med.method]]
                    </td>
                    <td>
                      [[med.dosage]]
                    </td>
                    <td>
                      <span hidden="[[!med.comment]]">
                        <paper-icon-button
                          class="commentButton"
                          icon="communication:comment"
                          on-tap="editMed">
                        </paper-icon-button>
                      </span>
                    </td>
                    <td>
                      <paper-icon-button on-tap="editMed" icon="editor:editor:mode-edit"></paper-icon-button>
                    </td>
                  </tr>

                </template>
              </tbody>
            </table>

          </div>

        </iron-collapse>

        <paper-item class="timeChunkBar timeChunkNight">
          <P class="timeChunkLabel" on-tap="toggleNight">
            night
          </P>
          <p class="timeChunkTime">
            {{_computeTime(timesData, 'night')}}
          </p>
          <paper-icon-button
            class="timeChunkButton"
            icon="icons:more-vert"
            time-chunk="night"
            on-tap="timeChunkOptions">
          </paper-icon-button>
        </paper-item>
        <iron-collapse id="night">

          <div class="guuey-table">

            <p class="tableScrollLabel">
              swipe left scrolls table
            </p>

            <table>
              <thead>
                <tr>
                  <th>
                    Medication
                  </th>
                  <th>
                    Route
                  </th>
                  <th>
                    Dosage
                  </th>
                  <th>
                    Comment
                  </th>
                  <th>
                    Edit
                  </th>
                </tr>
              </thead>
              <tbody>
                <template
                  is="dom-repeat"
                  items="{{_computeMedList(medsData)}}"
                  as="med"
                  filter="filterNight"
                  observe="timeChunk">
                  <tr>
                    <td>
                      [[med.medicine]]
                    </td>
                    <td>
                      [[med.method]]
                    </td>
                    <td>
                      [[med.dosage]]
                    </td>
                    <td>
                      <span hidden="[[!med.comment]]">
                        <paper-icon-button
                          class="commentButton"
                          icon="communication:comment"
                          on-tap="editMed">
                        </paper-icon-button>
                      </span>
                    </td>
                    <td>
                      <paper-icon-button on-tap="editMed" icon="editor:editor:mode-edit"></paper-icon-button>
                    </td>
                  </tr>

                </template>
              </tbody>
            </table>

          </div>

        </iron-collapse>

      </div>

    </paper-card>
  </template>

  <script>

    Polymer({

      is: 'su-medication',
      ready:function(){
        this.fire("pageLoaded", {page:this.page});
        this.addEventListener("print", this.print);
        this.$.timesDB.ref.on("value",function(snapshot){
          this.timeChunkTimeCheck(snapshot);
        }.bind(this));
      },
      properties:{
        page:{
          type:String,
        },
        home:{
          type:String,
        },
        patient:{
          type:String,
        },
        medMethods:{
          type:String,
          value:[
            "Oral",
            "Topic",
            "Injection",
            "Nasal"
          ]
        },
        newMed:{
          type:Object,
          value:{
            weekdays:[
              "mo",
              "tu",
              "we",
              "th",
              "fr",
              "sa",
              "so"
            ]
          }
        },
      },
      timeTarget:{
        type:Object
      },
      defaultTimeChunkTimes:{
        type:Object,
        value:{
          morning:"09:00",
          afternoon:"13:00",
          evening:"19:00",
          night:"01:00"
        }
      },
      observers:[
        "editQuery(query1000 , query640)"
      ],
      behaviors:[
        Polymer.carePlanAnimation
      ],
      startNewMed:function(){
        this.$.medModal.toggle();
        this.hideSaveMed=false;
      },
      toggleTime:function(e){
        this.$.timeDialog.toggle();
        this.timeTarget=e.model.med;
      },
      editMed:function(e){
        this.newMedEdit=e.model.med;
        this.$.editMedModal.toggle();

      },
      saveEditMed:function(){
        this.$.medDB.path=null;
        var editPath=this.newMedEdit.parent;
        this.newMedEdit.parent=null;
        this.$.medDB.data.med=this.newMedEdit;
        this.$.medDB.data.log={};
        this.$.medDB.data.log.user=this.user.uid;
        this.$.medDB.data.log.time=Date.now();
        this.$.medDB.save("homes/"+this.home+"/patients/"+this.patient+"/medicationOutline/medications/"+editPath, null);
        this.$.editMedModal.toggle();
        this.newMedEdit={};
        this.hideEditingMed=true;
      },
      saveMed:function(e){
        this.$.medDB.path=null;
        this.$.medDB.data={};
        if(this.newMed.timeChunk && this.newMed.medicine){
          this.$.medDB.save("homes/"+this.home+"/patients/"+this.patient+"/medicationOutline/medications", null)
            .then(function(){
              this.$.medDB.data.med=this.newMed;
              this.$.medDB.data.log={};
              this.$.medDB.data.log.user=this.user.uid;
              this.$.medDB.data.log.time=Date.now();
              this.$.medDB.save(this.$.medDB.path, null)
                .then(function(){
                  this.newMed={};
                }.bind(this));
            }.bind(this));
          this.$.medModal.toggle();
          this.hideSaveMed=true;
        } else {
          this.fire("openToast",{toastText:"Please make sure that you have set a name and a time of day (morning, afternoon etc) for this new medication."});
        };
      },
      newTime:function(time){
        this.newMed.time=time;
        this.newMed.timeChunk=this.convertTime(rawTime);
      },
      setTime:function(time){
        var rawTime=this.$.timePicker.rawValue;
        var timeChunk=this.convertTime(rawTime);
        this.newMed.timeChunk=timeChunk;
      },
      timeChunkOptions:function(e){
        var timeChunk=e.target.getAttribute("time-chunk");
        this.timeChunkTarget=timeChunk;
        this.$.timeChunkModal.positionTarget=e.target;
        this.$.timeChunkModal.open();
      },
      setTimeEdit:function(time){
        var rawTime=this.$.editTimePicker.rawValue;
        var timeChunk=this.convertTime(rawTime);
        this.newMedEdit.timeChunk=timeChunk;
      },
      toggleMorning:function(){
        this.$.morning.toggle();
      },
      toggleAfternoon:function(){
        this.$.afternoon.toggle();
      },
      toggleEvening:function(){
        this.$.evening.toggle();
      },
      toggleNight:function(){
        this.$.night.toggle();
      },
      filterMorning:function(item){
        return item.timeChunk.indexOf("morning")!=-1;
      },
      filterAfternoon:function(item){
        return item.timeChunk.indexOf("afternoon")!=-1;
      },
      filterEvening:function(item){
        return item.timeChunk.indexOf("evening")!=-1;
      },
      filterNight:function(item){
        return item.timeChunk.indexOf("night")!=-1;
      },
      convertTime:function(rawTime){
        if(rawTime>=60*5 && rawTime<60*12){
          return "morning";
        } else if(rawTime>=60*12 && rawTime<60*17){
          return "afternoon";
        } else if(rawTime>=60*17 && rawTime<60*21){
          return "evening"
        } else {
          return "night";
        };
      },
      print:function(e){
        var printData=this.$.medsDB.data;
        var printable=window.open("","printable");
        printable.document.write("<html><head>");
        printable.document.write("</head><body>");
        printable.document.write("<div style='width:100% padding:5%;'>");
        printable.document.write("<p style='font-weight:bold;'>Medication List and History</p>");
        for(x in printData){
          var med=printData[x];
          for(y in med){
            var medHistory=med[y];
            var date=medHistory.log.time;
            var formattedDate=new Date(date);yy
            var printDate=formattedDate.getDay()+"."+formattedDate.getMonth()+"."+formattedDate.getFullYear();
            printable.document.write("<p style='font-weight:bold;'>"+formattedDate+"</p>");
            printable.document.write("<ul>");
            for(z in medHistory.med){
              printable.document.write("<li>"+this.convertToPrintText(z)+": "+medHistory.med[z]+"</li>");
            };
            printable.document.write("</ul>");
          };
        };
        printable.document.write("</body></html>");
        printable.document.write("</div>");
        printable.print();
        printable.close();
      },
      convertToPrintText:function(camelCase){
        if (camelCase == null || camelCase == "") {
          return camelCase;
        }

        camelCase = camelCase.trim();
        var newText = "";
        for (var i = 0; i < camelCase.length; i++) {
          if (/[A-Z]/.test(camelCase[i])
              && i != 0
              && /[a-z]/.test(camelCase[i-1])) {
            newText += " ";
          }
          if (i == 0 && /[a-z]/.test(camelCase[i]))
          {
            newText += camelCase[i].toUpperCase();
          } else {
            newText += camelCase[i];
          }
        }
        return newText;
      },
      _computeMedList:function(meds){
        //return the most recent sub doc from medication docs
        var currentMedList=[];
        var now = Date.now();
        for(x in meds){
          if(x!="timeChunks"){
            var med=meds[x];
            var medCandidate=null;
            for(y in med){
              var medHistory=med[y];
              if(medHistory.log){
                medTime = medHistory.log.time;
                if(medCandidate!=null){
                  if(medCandidate.log.time<medTime){
                    medCandidate=medHistory;
                  };
                } else {
                  medCandidate=medHistory;
                };
              };
            };
            medCandidate=medCandidate.med;
            medCandidate.parent=x;
            currentMedList.push(medCandidate);
          }
        };
        return currentMedList;
      },
      _computeTime:function(timeData, timeChunk){
        var newestCandidate;
        var currentChunk=timeData[timeChunk];
        for(x in currentChunk){
          var candidate=currentChunk[x];
          if(newestCandidate!=null){
            if(newestCandidate.log.time<candidate.log.time){
              newestCandidate=candidate;
            }
          } else {
            newestCandidate=candidate;
          };
        };
        if(newestCandidate){
          return newestCandidate.time;
        } else {
          return "loading...";
        }
      },
      editQuery:function(query1000, query640){
        if(query640){
          //table style
          this.customStyle["--table-scroll-lable-color"]="inherit";
          this.customStyle["--table-overflow"]="scroll";
          this.customStyle["--tbody-display"]="block";
          this.customStyle["--thead-tr-position"]="relative";
          this.customStyle["--thead-tr-display"]="block";
          this.customStyle["--thead-tr-td-width"]="150px";
          this.customStyle["--td-th-min-width"]="150px";
          this.customStyle["--td-th-last-width"]="150px";

          //fab styles
          this.customStyle["--main-fab-position"]="fixed";
          this.customStyle["--main-fab-top"]="unset";
          this.customStyle["--main-fab-bottom"]="5%";
          this.customStyle["--main-fab-right"]="5%";
          this.updateStyles();
        } else if(query1000){

          //table style
          this.customStyle["--table-scroll-lable-color"]="inherit";
          this.customStyle["--table-overflow"]="scroll";
          this.customStyle["--tbody-display"]="block";
          this.customStyle["--thead-tr-position"]="relative";
          this.customStyle["--thead-tr-display"]="block";
          this.customStyle["--thead-tr-td-width"]="150px";
          this.customStyle["--td-th-min-width"]="150px";
          this.customStyle["--td-th-last-width"]="150px";

          //fab styles
          this.customStyle["--main-fab-position"]="absolute";
          this.customStyle["--main-fab-top"]="-25px";
          this.customStyle["--main-fab-bottom"]="unset";
          this.customStyle["--main-fab-right"]="-25px";
          this.updateStyles();
        } else {
          this.customStyle["--table-scroll-lable-color"]="transparent";
          this.customStyle["--table-overflow"]="unset";
          this.customStyle["--tbody-display"]="table-row-group";
          this.customStyle["--thead-tr-position"]="unset";
          this.customStyle["--thead-tr-display"]="table-row";
          this.customStyle["--thead-tr-td-width"]="unset";
          this.customStyle["--td-th-min-width"]="unset";
          this.customStyle["--td-th-last-width"]="unset";

          //fab styles
          this.customStyle["--main-fab-position"]="absolute";
          this.customStyle["--main-fab-top"]="-25px";
          this.customStyle["--main-fab-bottom"]="unset";
          this.customStyle["--main-fab-right"]="-25px";
          this.updateStyles();
        };
      },
      editTimeDialog:function(){
        this.$.timeChunkModal.close();
        this.$.editTimeDialog.toggle();
      },
      saveEditTime:function(){
        this.$.timeDB.path=null;
        this.$.timeDB.data={};
        var path="homes/"+this.home+"/patients/"+this.patient+"/medicationOutline/timeChunks/"+this.timeChunkTarget;
        var now=Date.now();
        this.$.timeDB.data={
          log:{
            user:this.user.uid,
            time:now
          },
          time:this.newTime
        };
        this.$.timeDB.save(path, null)
          .then(function(val){
            this.$.editTimeDialog.close();
            this.newTime=null;
          }.bind(this))
          .catch(function(error){
            this.fire("openToast", {toastText:"Error saving new time: "+error});
          }.bind(this));
      },
      timeDialog:function(){
        this.$.timeDialog.toggle();
      },
      timeChunkTimeCheck:function(data){
        var now=Date.now();
        data=data.val();
        if(data===null){
          var path="homes/"+this.home+"/patients/"+this.patient+"/medicationOutline/";
          this.$.timeDB.data={
            morning:{
              genesis:{
                log:{
                  user:"system logged in as: "+this.user.uid,
                  time:now
                },
                time:"09:00"
              }
            },
            afternoon:{
              genesis:{
                log:{
                  user:"system logged in as: "+this.user.uid,
                  time:now
                },
                time:"13:00"
              }
            },
            evening:{
              genesis:{
                log:{
                  user:"system logged in as: "+this.user.uid,
                  time:now
                },
                time:"19:00"
              }
            },
            night:{
              genesis:{
                log:{
                  user:"system logged in as: "+this.user.uid,
                  time:now
                },
                time:"01:00"
              }
            },
          };
          this.$.timeDB.save(path,"timeChunks");
        };
      }
  });

  </script>

</dom-module>
