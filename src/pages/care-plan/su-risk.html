<link rel="import" href="../../../bower_components/polymer/polymer.html" />
<link rel="import" href="../../../bower_components/polymerfire/firebase-document.html" />
<link rel="import" href="../../../bower_components/polymerfire/firebase-query.html" />
<link rel="import" href="../../../bower_components/paper-card/paper-card.html" />
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html" />
<link rel="import" href="../../../bower_components/paper-button/paper-button.html" />
<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html" />
<link rel="import" href="../../../bower_components/paper-input/paper-input.html" />
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html" />
<link rel="import" href="../../../bower_components/vaadin-combo-box/vaadin-combo-box.html" />
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html" />
<link rel="import" href="../../../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html" />
<link rel="import" href="../../../bower_components/neon-animation/neon-animated-pages.html" />

<link rel="import" href="../../elements/guuey-text-input/guuey-text-input.html" />
<link rel="import" href="../../elements/guuey-date-input/guuey-date-input.html" />
<link rel="import" href="../../elements/guuey-slider/guuey-slider.html" />
<link rel="import" href="../../elements/su-header/su-header.html" />
<link rel="import" href="../../elements/media-queries/media-queries.html" />

<link rel="import" href="su-risk-edit-view.html" />
<link rel="import" href="su-risk-multi-view.html" />

<link rel="import" href="../../behaviors/fab-animation-behavior.html" />
<link rel="import" href="../../behaviors/animations/care-plan-animation.html" />
<link rel="import" href="../../behaviors/su-resize-behavior.html" />
<link rel="import" href="../../behaviors/su-print-behavior.html" />

<link rel="import" href="../../styles/common-styles.html" />

<dom-module id="su-risk">

  <template>

    <media-queries
      dimensions="{{dimensions}}">
    </media-queries>

    <app-indexeddb-mirror
      id="risksMirror"
      session="[[userUid]]"
      key="risksDB|[[patient]]"
      data="{{risksDataLive}}"
      persisted-data="{{risksData}}"
      worker-url="/bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror-worker.js">
    </app-indexeddb-mirror>

    <!--firebase query to get all of the risk assessments-->
    <firebase-query
      id="risksDB"
      path="/homes/[[home]]/patients/[[patient]]/riskAssessment"
      data="{{risksDataLive}}"
      app-name="main">
    </firebase-query>

    <app-indexeddb-mirror
      id="riskMirror"
      session="[[userUid]]"
      key="riskDB|[[riskId]]|[[patient]]"
      data="{{riskDataLive}}"
      persisted-data="{{riskData}}"
      worker-url="/bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror-worker.js">
    </app-indexeddb-mirror>

    <!--db to edit single document that has been selected-->
    <firebase-document
      id="riskDB"
      data="{{riskDataLive}}"
      app-name="main">
    </firebase-document>

    <style include="common-styles"></style>

    <paper-dialog id="addRiskDialog" class="guuey-modal guuey-add-modal">

      <h2>Add New Goal</h2>

      <vaadin-combo-box
        class="dialogHalf"
        label="Category"
        items="[[riskTypes]]"
        value="{{riskData.category}}">
      </vaadin-combo-box>

      <guuey-date-input
        class="dialogHalf"
        value="{{riskData.date}}"
        label="Date of risk assessment">
      </guuey-date-input>

      <paper-textarea
        label="Background of Risk"
        value="{{riskData.backgroundOfRisk}}">
      </paper-textarea>

      <paper-textarea
        label="Risk Identified"
        value="{{riskData.riskIdentified}}">
      </paper-textarea>

      <paper-textarea
        label="Crisis Plan"
        value="{{riskData.crisisPlan}}">
      </paper-textarea>

      <vaadin-combo-box
        class="dialogHalf"
        label="Agreed Frequencey of Evaluation"
        items="[[evalFreq]]"
        value="{{riskData.agreedFrequencyOfEvaluation}}">
      </vaadin-combo-box>

      <guuey-date-input
        class="dialogHalf"
        value="{{riskData.evaluation}}"
        label="Date of risk evaluation">
      </guuey-date-input>

      <guuey-slider
        class="dialogHalf"
        value="{{riskData.riskLevel}}">
      </guuey-slider>
      <div class="modal-button-container">
        <paper-button class="cancel-button" on-tap="cancelNewRisk">cancel</paper-button>
        <paper-button class="confirm-button" on-tap="saveNewRisk">save</paper-button>
      </div>

    </paper-dialog>

    <paper-card class="pageCard" elevation="3">
      <su-header
        page="Risk Assessment"
        home="[[home]]"
        patient="[[patient]]">
      </su-header>

      <div class="pageInnerCont">

        <!--absolute position button to add a new risk-->

        <paper-fab
          id="regFab"
          icon="icons:add"
          on-tap="addRisk">
        </paper-fab>

        <!--fixed position button to finsh adding a new risk assessment and close the add view-->

        <paper-fab
          id="editFab"
          icon="icons:check"
          on-tap="finishRisk">
        </paper-fab>

        <neon-animated-pages
          entry-animation="scale-up-animation"
          exit-animation="scale-down-animation"
          attr-for-selected="name"
          selected="[[pageState]]">

          <su-risk-multi-view
            name="multi-view"
            risks-data="{{risksData}}">
          </su-risk-multi-view>

          <su-risk-edit-view
            db-loaded="[[dbLoaded]]"
            name="edit-view"
            risk-data="{{riskData}}">
          </su-risk-edit-view>

        </neon-animated-pages>

      </div>

    </paper-card>

  </template>

  <script>

    Polymer({

      is: 'su-risk',

      ready: function() {
        this.fire("pageLoaded", {page: this.page});
        this.addEventListener("print", this.print);
        this.addEventListener("editRisk", this.editRisk);
        this.addEventListener("deleteRisk", this.deleteRisk);
      },

      properties: {

        dbLoaded: {
          type: Boolean,
          value: false
        },

        dimensions: {
          type: Object
        },

        page: {
          type: String,
        },

        patient: {
          type: String,
        },

        home: {
          type: String,
        },

        inputDisabled: {
          type: Boolean,
          value: true
        },

        pageState: {
          type: String,
          value: "multi-view"
        },

        riskId: {
          type: String,
          value: null
        },

        evalFreq: {
          type: Array,
          value: [
            "daily",
            "weekly",
            "bi-weekly",
            "monthly",
            "bi-monthly",
            "yearly"
          ]
        },

        riskTypes: {
          type: Array,
          value: [
            "Moving & Handling",
            "Slips & Trips",
            "Violence & Agression",
            "Falls From Windows & Balconies",
            "Scalding & Burning",
            "Bedrail Entrapment",
            "Legionella",
            "Other"
          ]
        }

      },

      observers: [
        "requirementsMet(risksData)"
      ],

      behaviors: [
        Polymer.fabAnimationBehavior,
        Polymer.carePlanAnimation,
        Polymer.suPrintBehavior,
        Polymer.suResizeBehavior,
      ],

      editRisk: function(e) {
        var riskId = e.detail.riskId;
        this.$.riskDB.path = "/homes/" + this.home + "/patients/" + this.patient + "/riskAssessment/" + riskId;
        this.animateEditViewFab();
        this.goEdit();
      },

      deleteRisk: function(e) {
        var riskId = e.detail.riskId;
        var path = "/homes/" + this.home + "/patients/" + this.patient + "/riskAssessment/" + riskId;
        this.$.riskDB.setStoredValue(path, null)
        .then(function() {
          this.fire("riskAssessmentDeleted");
        }.bind(this));
      },

      goEdit: function() {
        this.pageState = "edit-view";
      },

      goMulti: function() {
        this.pageState="multi-view";
      },

      toggleEdit: function() {
        this.inputDisabled = !this.inputDisabled;
      },

      addRisk: function() {
        this.$.riskDB.path = null;
        this.$.riskDB.data = {};
        this.$.addRiskDialog.open();
      },

      saveNewRisk: function() {
        var path = "/homes/" + this.home + "/patients/" + this.patient + "/riskAssessment";
        this.$.riskDB.save(path, null)
          .then(function(val) {
            var riskId = this.$.riskDB.path.split("/").pop();
            this.$.addRiskDialog.close();
            this.fire("newRiskAssessmentSaved", {riskId: riskId});
            this.fire("openToast",{toastText: "New risk assessment saved."});
          }.bind(this))
          .catch(function(error) {
            this.$.addRiskDialog.close();
            this.fire("openToast",{toastText: "There was an error saving the new risk: " + error});
          }.bind(this));
      },

      cancelNewRisk: function() {
        this.$.addRiskDialog.close();
        this.$.riskDB.data = {};
      },

      finishRisk: function(e) {
        this.pageState = "multi-view";
        this.$.riskDB.path = null;
        this.animateMultiViewFab();
      },

      requirementsMet: function(data) {
        //change case
        this.$.risksDB.query.on("child_changed", function() {
          var riskData = this.$.riskDB.data;
          if(!riskData.date) {
            this.fire("openToast", {toastText: "Date of risk assessment is reqiured."});
          };
        }.bind(this));
      }

    });

  </script>

</dom-module>
