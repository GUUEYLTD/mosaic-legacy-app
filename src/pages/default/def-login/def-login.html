<!--link in all elements for entire project... divide up into smaller pieces later-->
<link rel="import" href="dependencies.html" />
<dom-module id="def-login">

  <template>

    <media-queries
      dimensions="{{dimensions}}">
    </media-queries>

    <firebase-auth
      id="forgotUser"
      app-name="main">
    </firebase-auth>

    <style include="app-grid-style">
      :host {
        display: block;
        background-color:#2fc19e;
        position:fixed;
        z-index:20;
        top:0;
        left:0;
        bottom:0;
        right:0;
        --app-grid-columns:2;
        --app-grid-expandible-item-columns: 2;
        --app-grid-item-height:10%;
      }
      paper-button{
        margin:0px;
      }
      .loginBoxContainer{
        position:relative;
        width:100%;
        height:100%;
      }
      .loginBox{
        max-width:320px;
        max-height:640px;
        position:absolute;
        top:50%;
        left:50%;
        transform:translate(-50%, -50%);
      }
      .registerBox{
        max-width:320px;
        max-height:640px;
        position:absolute;
        top:50%;
        left:50%;
        transform:translate(-50%, -50%);
        background-color:#7e57c2;
        color:#FFFFFF;
      }
      .loginHeader{
        color:#2fc19e;
        text-transform:uppercase;
        font-size:24px;
        font-weight:bold;
        text-align:center;

      }
      .loginHeader p{
        padding:0;
        margin:0;
        padding-top:10px;

      }
      .loginButton{
        background-color:#41847d;
        color:#FFFFFF;

        @apply(--app-grid-expandible-item);
      }
      .toggleToRegister{

        background-color:#41847d;
        color:#FFFFFF;
      }
      .toggleToRegister:hover{
        background-color:#7e57c2;
        color:#FFFFFF;
      }
      .registerHeader{
        color:#FFFFFF;
        text-transform:uppercase;
        font-size:24px;
        font-weight:bold;
        text-align:center;
      }
      .registerHeader p{
        padding:0;
        margin:0;
        padding-top:10px;
      }
      .registerButton{
        background-color:#41847d;
        color:#FFFFFF;
        @apply(--app-grid-expandible-item);
      }
      .toggleToLogin{
        background-color:#41847d;
        color:#FFFFFF;
      }
      .toggleToLogin:hover{
        background-color:#FFFFFF;
        color:#2fc19e;
      }
      .registerInput{
        --paper-input-container-color:#FFFFFF;
        --paper-input-container-focus-color:#2fc19e;
        --paper-input-container-input-color:#2fc19e;
        @apply(--app-grid-expandible-item);
        margin:-5% 10% 5% 10%;
      }
      .registerInput:first-of-type{
        margin:0% 10% 5% 10%;
      }
      .loginInput{
        --paper-input-container-focus-color:#7e57c2;
        --paper-input-container-input-color:#7e57c2;
        @apply(--app-grid-expandible-item);
        margin:-5% 10% 5% 10%;
      }
      .loginInput:first-of-type{
        margin:0% 10% 5% 10%;
      }
      #forgotButton{
        @apply(--app-grid-expandible-item);
        opacity:.5;
      }
      #forgotButton:hover{
        opacity:1;
      }
      #forgotSection{
        @apply(--app-grid-expandible-item);
        padding:20px;
      }
      #forgotSuccess{
        @apply(--app-grid-expandible-item);
        padding:20px;
      }
      #forgotError{
        @apply(--app-grid-expandible-item);
        padding:20px;
      }
    </style>
    <div class="loginBoxContainer">

      <span hidden="{{registerHidden(state)}}">
        <paper-card
          elevation="3"
          class="app-grid registerBox">

          <div class="registerHeader">
            <p>
              register
            </p>
          </div>

          <paper-button class="toggleToLogin" on-tap="toggleState">Login</paper-button>
          <paper-input
            id="registerHome"
            on-valid="valid"
            class="registerInput"
            label="Care Home Name"
            value="{{newAccount.home}}"
            required
            auto-validate
            pattern="[a-zA-Z0-9\.\s]*"
            error-message="Invalid home name.">
          </paper-input>
          <paper-input
            id="registerUsername"
            class="registerInput"
            label="Email"
            value="{{newAccount.username}}"
            required
            auto-validate
            pattern="[a-zA-Z0-9_\.\+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-\.]+"
            error-message="Please enter a valid email.">
          </paper-input>
          <paper-input
            id="registerPassword"
            class="registerInput"
            label="Password"
            type="password"
            value="{{newAccount.password}}"
            required
            auto-validate
            pattern="^(?=.*\d).{8,16}$"
            error-message="Password must be between 8 and 16 characters long and include at least one number.">
          </paper-input>
          <paper-input
            id="registerPasswordConfirm"
            class="registerInput"
            label="Confirm Password"
            type="password"
            value="{{newAccount.passwordConfirm}}"
            required
            auto-validate
            pattern="{{newAccount.password}}"
            error-message="Passwords must match">
          </paper-input>
          <paper-button class="registerButton" on-tap="createNewAccount">Create an Account</paper-button>

        </paper-card>
      </span>

      <span hidden="{{loginHidden(state)}}">

        <paper-card
          elevation="3"
          class="app-grid loginBox">

          <div class="loginHeader">
            <p>
              log in
            </p>
          </div>

          <paper-button class="toggleToRegister" on-tap="toggleState">Register</paper-button>
          <paper-input
            class="loginInput"
            label="username"
            value="{{username}}"
            required
            auto-validate
            pattern="[a-zA-Z0-9_\.\+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-\.]+"
            error-message="Please enter a valid email."></paper-input>
          <paper-input class="loginInput" type="password" label="password" value="{{password}}"></paper-input>
          <paper-button class="loginButton" on-tap="emailSignIn">Login</paper-button>
          <paper-button id="forgotButton" on-tap="openForgotPass">Forgot Password?</paper-button>
          <iron-collapse id="forgotSection">

            <p>
              Please enter your email below and click reset password. A password reset email will be sent to your account email.
            </p>
            <paper-input label="Email Address" value="{{forgotEmail}}"></paper-input>

            <paper-button on-tap="resetPass">reset password</paper-button>

          </iron-collapse>

          <iron-collapse id="forgotSuccess">

            Success! Your password reset email has been sent to [[forgotEmail]]. Please allow 5 minutes before trying to send the password email again.

          </iron-collapse>

          <iron-collapse id="forgotError">
            <p>
              Oops! Something went wrong! The error is:
              [[error]]
            </p>
            <p>
              Please try again, contact your care home administrator, or contact support.
            </p>

          </iron-collapse>

        </paper-card>

      </span>

    </div>

  </template>

  <script>

    Polymer({

      is: 'def-login',
      properties:{
        page:{
          type:String,
        },
        home:{
          type:String,
        },
        signedIn:{
          type:Boolean,
        },
        newAccount:{
          type:Object,
          value:{
            username:"",
            password:"",
            home:""
          },
        },
        state:{
          type:String,
          value:'login'
        }
      },
      observers:[

      ],
      behaviors:[
        Polymer.defPagesAnimation,
        Polymer.defaultResizeBehavior
      ],
      validateInputs:function(){
        var validArray=[];
        var result=false;
        validArray.push(this.$.registerHome.validate());
        validArray.push(this.$.registerUsername.validate());
        validArray.push(this.$.registerPassword.validate());
        validArray.push(this.$.registerPasswordConfirm.validate());
        for(i=0; i<validArray.length; i++){
          if(validArray[i]===true){
            result=true;
          } else {
            result=false;
            break;
          };
        };
        return result;
      },
      createNewAccount:function(){
        console.log(this.validateInputs());
        if(this.validateInputs()){
          this.fire('createNewAccount',this.newAccount);
        } else {
          this.fire("openToast", {toastText:"Your entered details are invalid, or you have not entered a username or password."})
        };
      },
      //computed binding to show correct card
      registerHidden:function(state){
        if(state==="register"){
          return false;
        } else {
          return true;
        };
      },
      //computed binding to show correct card
      loginHidden:function(state){
        if(state==="login"){
          return false;
        } else {
          return true;
        };
      },
      toggleState:function(){
        if(this.state==="login"){
          this.state="register";
        } else {
          this.state="login";
        };
      },
      emailSignIn:function(){
        var details={
          username:this.username,
          password:this.password
        };
        this.fire('emailSignIn',details);
      },
      openForgotPass:function(){
        this.$.forgotSection.toggle();
      },
      resetPass:function(){
        this.$.forgotUser.auth.sendPasswordResetEmail(this.forgotEmail)
          .then(function(){
            this.$.forgotSuccess.show();
            this.$.forgotError.hide();
            this.$.forgotSection.hide();
          }.bind(this),
          function(error){
            this.$.forgotSuccess.hide();
            this.$.forgotError.show();
            this.error=error;
          }.bind(this));
      },
    });

  </script>

</dom-module>
