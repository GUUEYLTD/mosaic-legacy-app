<link rel="import" href="dependencies.html" />
<dom-module id="def-home">

  <template>

    <media-queries
      dimensions="{{dimensions}}">
    </media-queries>

    <firebase-query
      id="suIndexDB"
      path="/homes/[[home]]/patients/suIndex"
      data="{{patientListLive}}"
      app-name="main">
    </firebase-query>
    <app-indexeddb-mirror
      id="suIndexDBIndex"
      key="suIndexDB"
      data="{{patientListLive}}"
      persisted-data="{{patientList}}"
      worker-url="../../../../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror-worker.js">
    </app-indexeddb-mirror>
    <firebase-document
      id="fireDoc"
      app-name="main">
    </firebase-document>

    <style include="app-grid-style">
    :host{
      --app-grid-columns:5;
      --app-grid-item-height:150%;
    }
    .multiBoxContainer{
      margin-top:25px;
      margin-right:10%;
      margin-left:10%;
    }
    .suBox{
      margin:20px;
      margin:var(--su-box-margin);
      position:relative;
    }
    .suBoxImage{
      width:100%;
      height:50%;
    }
    .suBoxImage:hover{
      cursor:pointer;
    }
    .suspendedText{
      text-transform:uppercase;
      width:80%;
      color:red;
      font-size:24px;
      font-weight:bold;
      position:absolute;
      text-align:center;
      z-index:2;
      top:25%;
      left:10%;
    }
    .activeImage{
      height:auto;
      width:auto;
      background-color: lightgray;
    }
    .suLower{
      padding: 10px 10px 10px 10px;
      position:absolute;
      bottom:0;
    }
    .suEdit{
      position:absolute;
      bottom:0;
      right:0;
    }
    paper-fab{
      position:absolute;
      right:5%;
      top:140px;
      z-index:1;
      /*polyme overrides*/
      position:var(--main-fab-position);
      bottom:var(--main-fab-bottom);
      top:var(--main-fab-top);
      right:var(--main-fab-right);
    }
    #activeDialog{
      margin:0;
    }
    #suspendedDialog{
      margin:0;
    }
    </style>

    <paper-dialog id="activeDialog" no-overlap horizontal-align="left" vertical-align="top">
      <paper-button on-tap="editServiceUser">edit</paper-button>
      <br />
      <paper-button on-tap="suspendServiceUser">suspend</paper-button>
      <br />
      <paper-button on-tap="archiveUser">archive</paper-button>
    </paper-dialog>

    <paper-dialog id="suspendedDialog" no-overlap horizontal-align="left" vertical-align="top">
      <paper-button on-tap="editServiceUser">edit</paper-button>
      <br />
      <paper-button on-tap="unSuspendServiceUser">un-suspend</paper-button>
      <br />
      <paper-button on-tap="archiveUser">archive</paper-button>
    </paper-dialog>

    <paper-fab
      id="mainFab"
      elevation="3"
      icon="icons:add"
      on-tap="createNewPatient">
    </paper-fab>

    <div class="multiBoxContainer">
      <div class="app-grid" has-aspect-ratio>
        <template
          is="dom-repeat"
          items="[[patientList]]"
          filter="filterArchived"
          observe="currentStatus"
          as="su">

            <div hidden="{{!_computeSuspended(su.currentStatus)}}" class="suBoxWrapper">
              <paper-card
                class="suBox"
                elevation="3">
              <a hidden href="/[[home]]/care-plan/su-profile/[[su.$key]]"></a>
                <iron-image
                  class="suBoxImage"
                  sizing="cover"
                  preload
                  placeholder="../../../../images/defaultAvatar.png"
                  fade
                  src="[[su.image]]"
                  on-tap="goProfile">
                </iron-image>

                <p class="suspendedText">
                  suspended
                </p>
                <div class="suLower">
                  [[su.fName]]
                  <br />
                  [[su.lName]]
                </div>
                <paper-icon-button class="suEdit" on-tap="openSuspendedDialog" icon="icons:more-vert"></paper-icon-button>
              </paper-card>
            </div>

            <div hidden="{{_computeSuspended(su.currentStatus)}}" class="suBoxWrapper">
              <paper-card
                class="suBox"
                elevation="3">
                <a hidden href="/[[home]]/care-plan/su-profile/[[su.$key]]"></a>
                  <iron-image
                    class="suBoxImage"
                    sizing="cover"
                    preload
                    placeholder="../../../../images/defaultAvatar.png"
                    fade
                    src="[[su.image]]"
                    on-tap="goProfile">
                  </iron-image>
                <div class="suLower">
                  [[su.fName]]
                  <br />
                  [[su.lName]]
                </div>
                <paper-icon-button class="suEdit" on-tap="openDialog" icon="icons:more-vert"></paper-icon-button>
              </paper-card>
            </div>

        </template>

    </div>
  </div>
    <div style="height:100px;">
      <!--padding for bottom-->
    </div>
  </template>

  <script>

    Polymer({

      is: 'def-home',
      ready:function(){
        this.fire("dbLoaded", {page:"def-home"});
      },
      properties:{
        patient:{
          type:String,
        },
        page:{
          type:String,
        },
        home:{
          type:String,
        },
        signedIn:{
          type:Boolean,
        },
        newAccount:{
          type:Object,
          value:{},
        },
      },
      observers:[
        "dbLoaded(patientList)"
      ],
      behaviors:[
        Polymer.defPagesAnimation,
        Polymer.defaultResizeBehavior
      ],
      createNewPatient:function(){
        this.$.fireDoc.path=null;
        this.$.fireDoc.data={
          home:this.home,
          currentStatus:"archived"
        };
        this.$.fireDoc.save('/homes/'+this.home+'/patients', null)
          .then(function(){
            var patientPath='/homes/'+this.home+'/patients';
            this.patient = this.$.fireDoc.path.slice(patientPath.length+1);
            window.location.href="/"+this.home+"/care-plan/su-create/"+this.patient;
          }.bind(this));
      },
      createNewAccount:function(){
        this.fire('createNewAccount',this.newAccount);
      },
      openDialog:function(e) {
        this.$.activeDialog.positionTarget = e.target;
        if(e.model.su && e.model.su){
          if(e.model.su.fName && e.model.su.lName){
            this.modalFirstName=e.model.su.fName;
            this.modalLastName=e.model.su.lName;
          }
        }
        this.modalKey=e.model.su.$key;
        this.$.activeDialog.toggle();
      },
      openSuspendedDialog:function(e) {
        this.$.suspendedDialog.positionTarget = e.target;
        if(e.model.su && e.model.su){
          if(e.model.su.fName && e.model.su.lName){
            this.modalFirstName=e.model.su.fName;
            this.modalLastName=e.model.su.lName;
          }
        }
        this.modalKey=e.model.su.$key;
        this.$.suspendedDialog.toggle();
      },
      editServiceUser:function(e){
        if(e.model){
          window.open("/"+this.home+"/care-plan/su-profile/"+e.model.su.$key, '_self');
        } else {
          window.open("/"+this.home+"/care-plan/su-profile/"+this.modalKey, '_self');
        };
      },
      suspendServiceUser:function(e){
        var path=this.$.suIndexDB.path+"/"+this.modalKey+"/currentStatus";
        this.$.suIndexDB.setStoredValue(path, "suspended");
        this.$.activeDialog.toggle();
      },
      unSuspendServiceUser:function(e){
        var path=this.$.suIndexDB.path+"/"+this.modalKey+"/currentStatus";
        this.$.suIndexDB.setStoredValue(path, "active");
        this.$.suspendedDialog.toggle();
      },
      archiveUser:function(e){
        var path=this.$.suIndexDB.path+"/"+this.modalKey+"/currentStatus";
        this.$.suIndexDB.setStoredValue(path, "archived");
        this.$.activeDialog.toggle();
      },
      filterArchived:function(su){
        return su.currentStatus!=="archived";
      },
      //check to see if the remaining non archived service users are suspended or not
      _computeSuspended:function(status){
        return status=="suspended";
      },
      _computeQueryCount:function(su){
        if(su.currentStatus!="archived"){
          if(!this.queryCount){
            this.queryCount=0;
          };
          this.queryCount++;
        }
      },
      _computeImage:function(image){
        if(image){
          return image;
        } else {
          return "../../../../images/defaultAvatar.png";
        };
      },
      dbLoaded:function(data){
        this.$.suIndexDB.query.on("value", function(){
            this.fire("dbLoaded");
        }.bind(this));
      },
    });

  </script>

</dom-module>
