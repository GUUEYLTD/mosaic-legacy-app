<link rel="import" href="dependencies.html" />

<dom-module id="def-account">
  <template>

    <firebase-auth
      id="auth"
      app-name="main"
      user="{{user}}"
      signed-in="{{signedIn}}"
      status-known="{{statusKnown}}"
      on-error="handleError">
    </firebase-auth>

    <firebase-storage
      id="storage"
      app-name="main"
      set-name="false"
      path="uploads/[[home]]/[[user.uid]]"
      use64="true"
      url="{{homeImage}}">
    </firebase-storage>

    <style include="common-styles">
      .main{
        margin: 50px 10% 50px 10%;
        width:80%;
      }
    </style>

    <paper-dialog id="reAuthDialog">

      <p>
        Please re-authenticate before changing email or password
      </p>
      <paper-input label="email" value="{{reauth.email}}"></paper-input>
      <paper-input label="password" value="{{reauth.pass}}"></paper-input>
      <paper-button on-tap="_reAuth">re-authenticate</paper-button>

    </paper-dialog>

    <paper-card class="main">

      <div class="pageInnerCont padded">
        <h2>Current Info</h2>
        <p>
          displayName : [[user.displayName]]
        </p>
        <p>
          email : [[user.email]]
        </p>
        <img src="[[user.photoURL]]" />
        <h2>basic info</h2>
        <paper-input label="update display name" value="{{displayNameUpdate}}"></paper-input>
        <guuey-photo-editor value="{{photoURLUpdate}}"></guuey-photo-editor>
        <paper-button on-tap="_saveUserUpdate">update account</paper-button>

        <h2>secure info</h2>
        <paper-input label="update email" value="{{secureEmail}}"></paper-input>
        <paper-input label="confirm update email" value="{{secureEmailConfirm}}"></paper-input>
        <paper-input label="update password" value="{{securePass}}"></paper-input>
        <paper-input label="confrim update password" value="{{securePassConfirm}}"></paper-input>
        <paper-button on-tap="_saveSecureUpdate">update account</paper-button>
      </div>

    </paper-card>

  </template>

  <script>

      Polymer({

        is: 'def-account',
        ready:function(){
          this.fire("pageLoaded", {page:this.page});
        },
        properties:{
          user:{
            type:Object,
            observer:"_userChanged"
          },
          displayNameUpdate:{
            type:String,
            value:null
          },
          emailUpdate:{
            type:String,
            value:null
          },
          photoURLUpdate:{
            type:String
          },
          reauth:{
            type:Object,
            value:{}
          },
        },
        _userChanged:function(user){
          //console.log(user);
        },
        _saveUserUpdate:function(){
          var updateObj = {};

          if(this.displayNameUpdate){
            updateObj.displayName = this.displayNameUpdate;
            this.$.auth.user.updateProfile(updateObj)
              .then(function(){
                this.fire("openToast", {toastText: "Account updated."});
              }.bind(this), function(err){
                this.fire("openToast", {toastText: "There was an error updating your account: "+err});
              }.bind(this));
          };

          if(this.photoURLUpdate){
            this.$.storage._uploadFile(this.photoURLUpdate)
            .then(function(fileLoc) {
                updateObj.photoURL = fileLoc;
                this.$.auth.user.updateProfile(updateObj)
                  .then(function(){
                    this.fire("openToast", {toastText: "Account updated."});
                  }.bind(this), function(err){
                    this.fire("openToast", {toastText: "There was an error updating your account: "+err});
                  }.bind(this));
            }.bind(this), function(err){
              this.fire("openToast", {toastText:"There was an error saving your photo: "+err})
            }.bind(this));
          };
        },
        _saveSecureUpdate:function(){
          if(this.secureEmail){
            if(this.secureEmail != this.secureEmailConfirm){
              this.fire("openToast",{toastText:"Both email fields must match in order to update email."});
            } else {
              this.$.auth.user.updateEmail(this.secureEmail)
                .then(function(){
                  this.fire("openToast",{toastText:"Email Updated."});
                  this.$.reAuthDialog.close();
                }.bind(this), function(err){
                  if(err.code === "auth/requires-recent-login"){
                    this.fire("openToast", {toastText: "You must re-authenticate in order to update your email address."});
                    this.$.reAuthDialog.open();
                  } else {
                    this.fire("openToast", {toastText: "There was an error updating your email: "+err});
                  };
                }.bind(this));
            };
          };
          if(this.securePass){
            if(this.securePass != this.securePassConfirm){
              this.fire("openToast",{toastText:"Both password fields must match in order to update password."});
            } else {
              this.$.auth.user.updatePassword(this.securePass)
                .then(function(){
                  this.fire("openToast",{toastText:"Password Updated."});
                  this.$.reAuthDialog.close();
                }.bind(this), function(err){
                  if(err.code === "auth/requires-recent-login"){
                    this.fire("openToast", {toastText: "You must re-authenticate in order to update your password."});
                    this.$.reAuthDialog.open();
                  } else {
                    this.fire("openToast", {toastText: "There was an error updating your password: "+err});
                  };
                }.bind(this));
            };
          };
        },
        _reAuth:function(){
          this.$.auth.auth.signInWithEmailAndPassword(this.reauth.email, this.reauth.pass)
            .then(function(){
              this._saveSecureUpdate();
            }.bind(this), function(err){
              this.fire("openToast", {toastText: "There was an error re-authenticating: "+err+" Try again."});
            }.bind(this));

        }
      });

  </script>

</dom-module>
