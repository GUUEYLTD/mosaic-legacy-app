<link rel="import" href="dependencies.html" />

<dom-module id="ad-users">

  <template>
    <!--query to get a list of curent users-->
  <firebase-query
    id="usersDB"
    path="/homes/{{home}}/users"
    data="{{usersData}}"
    app-name="main">
  </firebase-query>
  <!--user db for updating a user-->
  <firebase-document
    id="userDB"
    app-name="main"
    data="{{userData}}">
  </firebase-document>
  <!--query to get list of service users to attach to care workers-->
  <firebase-query
    id="suUsersDB"
    path="/homes/{{home}}/patients"
    data="{{susData}}"
    app-name="main">
  </firebase-query>
  <iron-media-query
    query="(max-width:900px)"
    query-matches="{{query900}}">
  </iron-media-query>
    <style>
      .mainCard{
        width:80%;
        margin: -50px 10% 50px 10%;
        padding-bottom:50px;
        position:absolute;
      }
      .tableScrollLabel{
        font-weight:bold;
        text-transform:uppercase;
        margin-bottom:0px;
        padding-bottom:0px;
        font-size:10px;
        padding-left:20px;
        color:var(--table-scroll-lable-color);
      }
      .tableContainer{
        padding:20px;
        height:auto;
        overflow:var(--table-overflow);
      }
      .tableContainer table{
        padding:20px;
        width:100%;
      }
      table{
        background-color:var(--table-background-color);
      }
      tbody{
        display:var(--tbody-display);
      }
      thead tr{
        position:var(--thead-tr-position);
        display:var(--thead-tr-display);
      }
      td{
        width:var(--thead-tr-td-width);
      }
      th{
        text-align:left;
      }
      td,th{

      }
      td,th{
        min-width:var(--td-th-min-width);
      }
      td,th:last-of-type{
        width:var(--td-th-last-width);
      }
      #userDialog{
        margin:0;
      }
      .mainFab{
        position:absolute;
        right:5%;
        top:235px;
        z-index:1;
        position:var(--main-fab-position);
        bottom:var(--main-fab-bottom);
        top:var(--main-fab-top);
        right:var(--main-fab-right);
      }
      .userImage{
        width:50px;
        height:50px;
        background-color:lightgray;
        border: 1px solid grey;
        border-radius:100%;
        margin-left:5px;

      }
      .userImage:hover{
        cursor: pointer;
      }
      .imageButton{
        height: 60px;
        width: 60px;
        margin:0px;
        padding:0px;
      }
    </style>

    <paper-fab
      class="mainFab"
      icon="icons:add"
      on-tap="addUser">
    </paper-fab>

    <input
      id="imageInput"
      type="file"
      on-change="_inputChanged"
      hidden>
    </input>

    <paper-dialog id="addUserDialog">

        <h2>Add A Care Worker or Manager</h2>
        <paper-input
          label="Name"
          value="{{newAccount.fName}}"
          required
          auto-validate
          pattern="[a-zA-Z\s]*"
          error-message="Please enter a valid name with no special characters.">
        </paper-input>

        <paper-input
          label="Surname"
          value="{{newAccount.lName}}"
          required
          auto-validate
          pattern="[a-zA-Z\s]*"
          error-message="Please enter a valid surname with no special characters.">
        </paper-input>

        <paper-input
          label="Username/Email"
          value="{{newAccount.username}}"
          required
          auto-validate
          pattern="[a-zA-Z0-9_\.\+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-\.]+"
          error-message="Please enter a valid email address as the username.">
        </paper-input>

        <paper-dropdown-menu label="Role">
          <paper-listbox attr-for-selected="value" selected="{{newAccount.role}}" class="dropdown-content">
            <paper-item value="manager">Manager</paper-item>
            <paper-item value="careWorker">Care Worker</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>

        <paper-dropdown-menu label="Service Users Supervised">
          <paper-listbox multi attr-for-selected="value" selected-values="{{newAccount.patients}}" class="dropdown-content">
            <template is="dom-repeat" items="{{susData}}">
              <paper-item value="{{item.$key}}">{{item.personalProfile.lName}}, {{item.personalProfile.fName}}</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
        <paper-button on-tap="createNewUser">Create</paper-button>

    </paper-dialog>

    <paper-dialog id="editUserDialog">

        <h2>User Info</h2>
        <paper-input
          label="Name"
          value="{{userData.name}}"
          required
          auto-validate
          pattern="[a-zA-Z\s]*"
          error-message="Please enter a valid name with no special characters.">
        </paper-input>
        <paper-input
          label="Surname"
          value="{{userData.surname}}"
          required
          auto-validate
          pattern="[a-zA-Z\s]*"
          error-message="Please enter a valid surname with no special characters.">
        </paper-input>
        <paper-input
          label="Username/Email"
          value="{{userData.email}}"
          required
          auto-validate
          pattern="[a-zA-Z0-9_\.\+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-\.]+"
          error-message="Please enter a valid email address as the username.">
        </paper-input>

        <paper-dropdown-menu label="Role">
          <paper-listbox attr-for-selected="value" selected="{{userData.role}}" class="dropdown-content">
            <paper-item value="manager">Manager</paper-item>
            <paper-item value="careWorker">Care Worker</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>

        <paper-dropdown-menu label="Service Users Supervised">
          <paper-listbox multi attr-for-selected="value" selected-values="{{userData.patients}}" class="dropdown-content">
            <template is="dom-repeat" items="{{susData}}" as="serviceUser">
              <paper-item value="{{serviceUser.$key}}">{{serviceUser.personalProfile.lName}}, {{serviceUser.personalProfile.fName}}</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>

    </paper-dialog>
    <paper-dialog id="userDialog" no-overlap horizontal-align="left" vertical-align="bottom">
      <paper-button on-tap="editUser">edit</paper-button>
      <br />
      <paper-button on-tap="suspendUser">suspend</paper-button>
      <br />
      <paper-button on-tap="archiveUser">archive</paper-button>
    </paper-dialog>

    <paper-card class="mainCard" elevation="3">
      <admin-header
        page="Users"
        icon="social:group">
      </admin-header>

      <div class="tableContainer">

        <p class="tableScrollLabel">
          swipe left scrolls table
        </p>

        <table>
          <thead>
            <tr>
              <th>
                Profile Picture
              </th>
              <th>
                Staff Member
              </th>
              <th>
                Name
              </th>
              <th>
                Status
              </th>
              <th>
                Contact
              </th>
              <th>
                Edit
              </th>
            </tr>
          </thead>
          <tbody>
            <template is="dom-repeat" items="{{usersData}}" as="user">

              <tr>
                <td hidden="{{user.image}}">
                  <paper-icon-button
                    class="imageButton"
                    on-tap="_onAddFilesClick"
                    icon="icons:account-circle"
                    hidden="[[!setimage]]">
                  </paper-icon-button>
                </td>
                <td hidden="[[!user.image]]">
                  <iron-image
                    class="userImage"
                    sizing="cover"
                    preload
                    fade
                    src="[[user.image]]"
                    on-tap="_onAddFilesClick">
                  </iron-image>
                </td>
                <td>
                  [[user.email]]
                </td>
                <td>
                  [[user.displayName]]
                </td>
                <td>
                  [[user.role]]
                </td>
                <td>
                  <paper-icon-button icon="communication:email"></paper-icon-button>
                </td>
                <td>
                  <paper-icon-button icon="icons:more-vert" on-tap="userOptions"></paper-icon-button>
                </td>
              </tr>

            </template>
          </tbody>
        </table>
      </div>
    </paper-card>

  </template>

  <script>

    Polymer({

      is: 'ad-users',
      ready:function(){
        this.fire("pageLoaded", {page:this.page});
      },
      properties:{
        newAccount:{
          type:Object,
          value:{
            username:"",
            password:"",
            role:"",
          }
        },
        user:{
          type:Object,
        },
        home:{
          type:Object,
        }
      },
      observers:[
        "editQuery(query900)"
      ],
      createNewUser:function(){
        this.fire("createNewUser", this.newAccount);
        this.newAccount={};
      },
      userOptions:function(e){
        this.$.userDB.path="/homes/"+this.home+"/users/"+e.model.user.$key;
        this.$.userDialog.positionTarget = e.target;
        this.$.userDialog.toggle();
      },
      addUser:function(){
        this.$.addUserDialog.toggle();
      },
      editUser:function(){
        this.$.editUserDialog.toggle();
        this.$.userDialog.toggle();
      },
      _inputChanged:function(e){
        var reader= new FileReader();
        var file=e.target.files[0];
        reader.readAsDataURL(file);
        reader.addEventListener("load", function () {
          this.$.userDB.setStoredValue("/homes/"+this.home+"/users/"+this.userID+"/image", reader.result);
        }.bind(this), false);
      },
      _onAddFilesClick: function(e) {
        this.userID=e.model.user.$key;
        if (document.createEvent) {
          this.$.imageInput.value = '';
          this.$.imageInput.click();
        }
      },
      editQuery:function(query900){
        if(query900){
          //table style
          this.customStyle["--table-scroll-lable-color"]="inherit";
          this.customStyle["--table-overflow"]="scroll";
          this.customStyle["--tbody-display"]="block";
          this.customStyle["--thead-tr-position"]="relative";
          this.customStyle["--thead-tr-display"]="block";
          this.customStyle["--thead-tr-td-width"]="150px";
          this.customStyle["--td-th-min-width"]="150px";
          this.customStyle["--td-th-last-width"]="150px";
          //fab style
          this.customStyle["--main-fab-position"]="fixed";
          this.customStyle["--main-fab-top"]="unset";
          this.customStyle["--main-fab-bottom"]="5%";

          this.updateStyles();
        } else {
          this.customStyle["--table-scroll-lable-color"]="transparent";
          this.customStyle["--table-overflow"]="unset";
          this.customStyle["--tbody-display"]="table-row-group";
          this.customStyle["--thead-tr-position"]="unset";
          this.customStyle["--thead-tr-display"]="table-row";
          this.customStyle["--thead-tr-td-width"]="unset";
          this.customStyle["--td-th-min-width"]="unset";
          this.customStyle["--td-th-last-width"]="unset";

          this.customStyle["--main-fab-position"]="absolute";
          this.customStyle["--main-fab-top"]="235px";
          this.customStyle["--main-fab-bottom"]="unset";
          this.updateStyles();
        };
      }
    });

  </script>

</dom-module>
